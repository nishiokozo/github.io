"use strict";

let canvas_gl = document.getElementById( "html_canvas_gl" );
let canvas_dbg = document.getElementById( "html_canvas_dbg" );
let canvas_out = document.getElementById( "html_canvas" );

let gl = canvas_gl.getContext( "webgl", { antialias: false } );			// gl


	const MaxAct = 100;

//-----------------------------------------------------------------------------
function html_error( str )
//-----------------------------------------------------------------------------
{
	document.getElementById("html_error").innerHTML = str;
}

//-----------------------------------------------------------------------------
function model_create_qubic( name, vecOfs, pos, sc, col_flat, col_wire  )	// vec3 vecOfs, vec3 pos, vec3 sc, vec3 col_flat, vec3 col_wire
//-----------------------------------------------------------------------------
{
	//ワイヤーフレームのキューブを作って描画するライブラリ。

	// キューブモデルの原型
	let vert_cmn = 
	[
		[-0.5*sc.x,-0.5*sc.y,-0.5*sc.z],
		[ 0.5*sc.x,-0.5*sc.y,-0.5*sc.z],
		[ 0.5*sc.x, 0.5*sc.y,-0.5*sc.z],
		[-0.5*sc.x, 0.5*sc.y,-0.5*sc.z],

		[-0.5*sc.x,-0.5*sc.y, 0.5*sc.z],
		[ 0.5*sc.x,-0.5*sc.y, 0.5*sc.z],
		[ 0.5*sc.x, 0.5*sc.y, 0.5*sc.z],
		[-0.5*sc.x, 0.5*sc.y, 0.5*sc.z],
	];

	let index_wire = 
	[
		0,1,
		1,2,
		2,3,
		3,0,

		4+0,4+1,
		4+1,4+2,
		4+2,4+3,
		4+3,4+0,

		0,4+0,
		1,4+1,
		2,4+2,
		3,4+3,
	];
	let tblIndex_flat = 
	[
		4,6,7,6,4,5,
		7,2,3,2,7,6,
		5,2,6,2,5,1,
		0,7,3,7,0,4,
		0,2,1,2,0,3,
		4,1,5,1,4,0,
	];

	function gen( pos )
	{
		let ofs = model.tblVertex3.length/3;
		for ( let v of vert_cmn )
		{
			model.tblVertex3.push( v[0] + pos.x );
			model.tblVertex3.push( v[1] + pos.y );
			model.tblVertex3.push( v[2] + pos.z );
		}
		for ( let id of index_wire )
		{
			model.tblIndex_wire.push( id+ofs );
		}
		for ( let id of tblIndex_flat )
		{
			model.tblIndex_flat.push( id+ofs );
		}
	}

	let model = {};

	// for model
	model.name = name;
	model.tblVertex3 = [];		// vec3
	model.tblIndex_wire = [];
	model.tblIndex_flat = [];
	model.col_flat = col_flat;
	model.col_wire = col_wire;
	//--基本の方向
	model.vofs = vec3( vecOfs.x, vecOfs.y, vecOfs.z );
	model.qp = QP( qidentity(), vec3( vecOfs.x, vecOfs.y, vecOfs.z ) );
	//--
	model.child = [];
	gen( pos );
	model.global_qp = QP( qidentity(),vec3(0,0,0) );

	// for edit
//	model.flgSelected = false;

	// motion data
	model.infForm = {};
	let act = 0;
	{
		model.infForm[act] = [];
		model.infForm[act].push( QP( model.qp.Q, model.qp.P ) );
	}


	// param
	model.param = {}
//	model.param["flgIK"] = false;
//	model.param["flgHide"] = false;
//	model.param["pad3"] = "(none)";


	return model;
}

	
function QP( Q, P )
{
	return {Q:Q,P:P};	// vec4 Q; vec3 P;
}

//-----------------------------------------------------------------------------
window.onload = function( e )
//-----------------------------------------------------------------------------
{

	let peri = pad_create();
	let ey = 2;
//	let edit_cam = cam_create( vec3(  0, ey, 12 ), vec3( 0, ey ,0 ), 28, 1.0,1000.0  );
	let edit_cam = cam_create( vec3( -12, ey, 0 ), vec3( 0, ey ,0 ), 28, 1.0,1000.0  );
//	ey-=0.75;let edit_cam = cam_create( vec3(  -10, ey, 0 ), vec3( 0, ey ,0 ), 28, 1.0,1000.0  );
	let play_cam = cam_create( vec3( -12, ey, 0 ), vec3( 0, ey ,0 ), 28, 1.0,1000.0  );
	let gra3d = gra3d_create( canvas_gl );
	let gra = gra_create( canvas_dbg );

	gl_reset( gra3d.gl );

	let text_x = 0;
	let text_y = 0;
	let text_W = canvas_dbg.width/16;
	let text_H = canvas_dbg.height/16;
	let text_buf = Array( text_W*text_H );
	function  text_print( str )
	{
		for ( let i=0 ; i < str.length ; i++ )
		{
			let s = str[i];
			gra.symbol( s, text_x,text_y,  16, "LT", 0 );
			text_x++;
			if ( text_x > canvas_dbg.width / 16 )
			{
				text_x=0;
				text_y++;
			}
		}
	}
	function text_locate( x, y )
	{
		text_x = x;
		text_y = y;
	}
	function gra_axis_circle( gra, v0, v1, v2  )	// vec3 v0:軸始点, v1:軸終点, v2:頂点
	{
		// v0~v1を軸に、v2を回転させ円を買う
		let step = 10;
		let axis = normalize( vsub( v1, v0 ) );
		let q = qrot_axis( axis, radians(step) );
		gra.colorv( C3 );

		let v = vsub(v2,v0);
		for ( let i = 0 ; i < 360/step ; i++ )
		{
			v = vmul_QvC( q, v );
			let v2 = vadd(v,v0);
			gra.dotv2( gra3d.pers2d(v2),2 );
		}
		gra.colorv( C0 );
	}
	function gra_axis_line( gra, Q, P, v1, v2 )
	{
		v1 = vmul_QvC( Q, v1 );
		v1 = vadd( v1, P );

		v2 = vmul_QvC( Q, v2 );
		v2 = vadd( v2, P );

		gra.linev2(gra3d.pers2d( v1 ),gra3d.pers2d( v2 ) );
		gra.dotv2(gra3d.pers2d( v1 ),2 );
		gra.dotv2(gra3d.pers2d( v2 ),2 );
	}
	function gra_axis_drawcursor( gra, Q, P, s )
	{
		let v0 = gra3d.pers2d( vadd( vmul_QvC( Q, vec3(0,0,0) ), P ) );
		let vx = gra3d.pers2d( vadd( vmul_QvC( Q, vec3(s,0,0) ), P ) );
		let vy = gra3d.pers2d( vadd( vmul_QvC( Q, vec3(0,s,0) ), P ) );
		let vz = gra3d.pers2d( vadd( vmul_QvC( Q, vec3(0,0,s) ), P ) );

		gra.colorv( C2 );gra.linev2( vx , v0 );
		gra.colorv( C4 );gra.linev2( vy , v0 );
		gra.colorv( C1 );gra.linev2( vz , v0 );
		gra.colorv( C0 );gra.dotv2( v0,3 );
	}


   	let sx = 0.45*0.7;//1.5*0.3;
   	let sy = 0.45*0.7;//1.0*0.3;
   	let sz = 0.40*0.7;//1.5*0.25;
   	let sk = 0.1;
   	// 											,position                  , shift                  , scale 
   	let C0 =  vec3(0.32,0.32,0.32);
   	let C1 =  vec3(0.32,0.32,0.90) ;
   	let C2 =  vec3(0.90,0.32,0.32) ;
   	let C3 =  vec3(0.90,0.32,0.90) ;
   	let C4 =  vec3(0.32,0.90,0.32) ;
   	let C5 =  vec3(0.32,0.72,0.72);
   	let C6 =  vec3(0.9,0.9,0.0) ;
   	let C7 =  vec3(1,1,1);
   	let C8 =  vec3(0.75,0.75,0.75);
   	let C9 =  vec3(0.5,0.5,0.5);
	//--
	const DS = 0.33;	// 胴サイズ
	const US = 0.75;	// 
	const AS = 0.5;	// 
	const A2 = 1.00;	// 
	let PartKoshi	= model_create_qubic( "腰＿",vec3(  0.0 ,  0.0,  0.0  ), vec3( 0  ,  0   , 0)	, vec3(1.1*AS ,0.6 ,0.6*AS ),C7,C0);
	let PartMomoR	= model_create_qubic( "右腿",vec3( -0.275, -0.1,  0.0  ), vec3(-0.0, -0.7 , 0)	, vec3(0.525*AS ,1.0 ,0.6*AS ),C7,C0);
	let PartMomoL	= model_create_qubic( "左腿",vec3(  0.275, -0.1,  0.0  ), vec3( 0  , -0.7, 0)	, vec3(0.525*AS ,1.0 ,0.6*AS ),C7,C0);
	let PartSuneR	= model_create_qubic( "右脚",vec3(  0.0 , -1.2,  0.0  ), vec3( 0  , -0.45 , 0)	, vec3(0.4*A2 ,1.1 ,0.4*A2 ),C7,C0);
	let PartSuneL	= model_create_qubic( "左脚",vec3(  0.0 , -1.2,  0.0  ), vec3( 0  , -0.45 , 0)	, vec3(0.4*A2 ,1.1 ,0.4*A2 ),C7,C0);
	let PartFootR	= model_create_qubic( "右足",vec3(  0.0 , -1.0,  0.0  ), vec3( 0  , -0.1 ,0.05)	, vec3(0.35 ,0.2 ,0.55 ),C7,C0);
	let PartFootL	= model_create_qubic( "左足",vec3(  0.0 , -1.0,  0.0  ), vec3( 0  , -0.1 ,0.05)	, vec3(0.35 ,0.2 ,0.55 ),C7,C0);
	let PartToeR	= model_create_qubic( "右爪",vec3(  0.0 , -0.2,  0.3  ), vec3( 0  , 0.1 ,0.10)	, vec3(0.35 ,0.2 ,0.15 ),C7,C0);
	let PartToeL	= model_create_qubic( "左爪",vec3(  0.0 , -0.2,  0.3  ), vec3( 0  , 0.1 ,0.10)	, vec3(0.35 ,0.2 ,0.15 ),C7,C0);
	let PartHead	= model_create_qubic( "頭＿"	,vec3(  0.0 ,  0.2,  0.0  ), vec3( 0  ,  0.25, 0)	, vec3(0.5 ,0.5 ,0.5 ),C7,C0);
	let PartKubi	= model_create_qubic( "首＿"	,vec3(  0.0 ,  0.6,  0.0  ), vec3( 0  ,  0.1 , 0)	, vec3(DS*0.35,0.2 ,DS*0.4 ),C7,C0);
	let PartMune	= model_create_qubic( "胸＿"	,vec3(  0.0 ,  0.6,  0.0  ), vec3( 0  ,  0.3 , 0)	, vec3(DS*0.9 ,0.6 ,DS*0.5 ),C7,C0);
	let PartHara	= model_create_qubic( "腹＿"	,vec3(  0.0 ,  0.3,  0.0  ), vec3( 0  ,  0.3 , 0)	, vec3(DS*0.8 ,0.6 ,DS*0.5 ),C7,C0);
	let PartKataR	= model_create_qubic( "右肩",vec3( -0.20 , 0.45,  0.0  ), vec3(-0.3,  0.00, 0)	, vec3(0.25 ,sk ,sk ),C7,C0);
	let PartKataL	= model_create_qubic( "左肩",vec3(  0.20,  0.45,  0.0  ), vec3( 0.3,  0.00, 0)	, vec3(0.25 ,sk ,sk ),C7,C0);
	let PartUde2R	= model_create_qubic( "右腕",vec3( -0.4 , -0.0,  0.0  ), vec3( 0.0, -0.45, 0)	, vec3(0.25*US,0.7 ,0.3*US ),C7,C0);
	let PartUde2L	= model_create_qubic( "左腕",vec3(  0.4 , -0.1,  0.0  ), vec3( 0  , -0.35, 0)	, vec3(0.25*US,0.7 ,0.3*US ),C7,C0);
	let PartUde1R	= model_create_qubic( "右尺",vec3(  0.0 , -0.8,  0.0  ), vec3( 0  , -0.35, 0)	, vec3(0.3*US ,0.7 ,0.25*US),C7,C0);
	let PartUde1L	= model_create_qubic( "左尺",vec3(  0.0 , -0.7,  0.0  ), vec3( 0  , -0.35, 0)	, vec3(0.3*US ,0.7 ,0.25*US ),C7,C0);
	let PartTeR		= model_create_qubic( "右手",vec3(  0.0 , -0.7, -0.0  ), vec3( 0  , -0.15, 0.0)	, vec3(sx ,sy ,sz),C7,C0);
	let PartTeL		= model_create_qubic( "右手",vec3(  0.0 , -0.7, -0.0  ), vec3( 0  , -0.15, 0.0)	, vec3(sx ,sy ,sz ),C7,C0);
	//--
	let PartAxis	= model_create_qubic( "脚軸",vec3(  0,0 ,  0.0,  0.0  ), vec3(-0.0, -0.5 , 0)	, vec3(0.1, 1.0 ,0.1 ),C7,C0);
	//--
	let curTblCur = 0;
	let curPart = [4,0,0];

	let cur_numAct = 0;//2;
	let cur_numCut = 0;//2;
//	let cur_disp_numAct = 0;//2;
	let cur_disp_numCut = 0;//2;
	cur_numAct = 0;//25;

	let cur_numTB = 0;//25;

	function ang(r){return radians(r);}
	function fixed(r){return r/1024.0;}
	function slCos(r){return Math.cos(r);}
	function slSin(r){return Math.sin(r);}

	let mode = "(modeNone)";

	let anim_limTime=0;
	let anim_numCut=0;
	let anim_numAct=0;
	let anim_cntCut=0;
	let anim_nextAct=0;

	let g_tblKeymodel = 	// キーフレーム管理をするモデルだけ登録
	[ 
		PartKoshi, PartHead,PartKubi,PartMune,PartHara,
		PartMomoR,PartSuneR,PartFootR, PartMomoL,PartSuneL,PartFootL,
		PartKataR,PartUde2R,PartUde1R,PartTeR, PartKataL,PartUde2L,PartUde1L,PartTeL,
	];
	
	let g_tblCur = 	// 編集対象のモデルだけ登録（編集グループに分ける）
	[ 
		[PartHead,PartKubi,PartMune,PartHara,PartKoshi],	//
		[PartMomoR,PartSuneR,PartFootR,  PartMomoL,PartSuneL,PartFootL ],	//	
//		[PartKataR,PartUde2R,PartUde1R,  PartKataL,PartUde2L,PartUde1L ],			//
		[PartUde2R,PartUde1R,  PartUde2L,PartUde1L ],			//
	];

	let g_tblVisibleModel = 		// 描画の為の階層構造
	[ PartKoshi, 
		[
			PartMomoR,[PartSuneR,[PartFootR,[PartToeR]]], 
			PartMomoL,[PartSuneL,[PartFootL,[PartToeL]]], 
			PartHara,[PartMune,[
				PartKubi,[PartHead],
				PartKataR,[PartUde2R,[PartUde1R,[PartTeR]]],
				PartKataL,[PartUde2L,[PartUde1L,[PartTeL]]]
			]],
		]
	];


	//------------------------------------------------------------------
	g_tblKeymodel.print = function()
	//------------------------------------------------------------------
	{
		console.log( this.length );
	}
	//------------------------------------------------------------------
	g_tblKeymodel.saveKeyframe = function()
	//------------------------------------------------------------------
	{
		let text = "[";
		for ( let model of this )
		{
			text += JSON.stringify( model.infForm );
			text += ",";
		}
		text += '""]\n';
		html.set("html_textarea",text);
		html.write("html_textarea");
		console.log( "saved" );
	}
	//------------------------------------------------------------------
	g_tblKeymodel.loadKeyframe = function()
	//------------------------------------------------------------------
	{
		html.read("html_textarea");
		let text = html.param["html_textarea"].val;
		let json = JSON.parse(text);		//JSON構文チェック
		//
		for ( let mdl = 0 ; mdl < this.length ; mdl++ )
		{
			if(0)
			{
				let inf = json[mdl];
				
				for ( let i = 0 ; i < Object.values(inf).length ; i++ )
				{
					let key = i; 			// keyframe number
					let value = inf[i];
					this[mdl].infForm[key] = [];
					for ( let j = 0 ; j < value.length ; j++ )
					{
						let Q = value[j].Q;
						let P = value[j].P;
//						if ( P == undefined ) P = vec4(0,0,0,0);
						//P.w = 0;
//						P = vadd( P, this[mdl].vofs );
						this[mdl].infForm[key].push( {Q:Q,P:P});
					}
				}

			}
			else
			{			
				this[mdl].infForm = json[mdl];
			}
		}

		if ( html.get("html_edit") == true )
		{
			form_get( g_tblKeymodel, cur_numAct, cur_numCut );
		}
		else
		{
			form_get( g_tblKeymodel, 0, 0 );
		}

	}

	
	{
let motiondataX='[{"0":[{"Q":{"w":0.9085409600397956,"x":-0.09549150281252622,"y":-0.4045084971874735,"z":-0.04251555625535744}},{"Q":{"w":0.8471006708862729,"x":-0.19773576836617307,"y":-0.4890738003669023,"z":-0.06424824579191724}},{"Q":{"w":0.8935822975543757,"x":-0.1899367807373567,"y":-0.397848471555116,"z":-0.08456530317942905}}],"1":[{"Q":{"w":0.9458465291882026,"x":-0.09052430460833638,"y":-0.30732416694677966,"z":-0.0522642316338267}},{"Q":{"w":0.9085409600397956,"x":-0.09549150281252622,"y":-0.4045084971874735,"z":-0.04251555625535744}},{"Q":{"w":0.9085409600397955,"x":-0.09549150281252622,"y":-0.4045084971874735,"z":-0.04251555625535744}}],"2":[{"Q":{"w":0.9458465291882026,"x":-0.09052430460833638,"y":-0.30732416694677966,"z":-0.0522642316338267}},{"Q":{"w":0.8062039377567942,"x":-0.2439081505784039,"y":0.4886773242663045,"z":-0.22746098033460724}},{"Q":{"w":0.6522542063053729,"x":-0.17672594815779716,"y":0.6806869815587674,"z":-0.28283851000365173}},{"Q":{"w":0.9177551064303765,"x":-0.3022597444656699,"y":0.2156290359102971,"z":-0.14095648395482163}}]},{"0":[{"Q":{"w":0.9898534383898226,"x":0.04982812373070708,"y":0.12591837783013074,"z":-0.04303359987204212}},{"Q":{"w":0.9898534383898226,"x":0.04982812373070708,"y":0.12591837783013074,"z":-0.04303359987204212}},{"Q":{"w":0.9898534383898226,"x":0.04982812373070708,"y":0.12591837783013074,"z":-0.04303359987204212}}],"1":[{"Q":{"w":0.9997839952930438,"x":-0.0061991036910615804,"y":0.01912280953040795,"z":0.005277501773005278}},{"Q":{"w":0.9898534383898226,"x":0.04982812373070708,"y":0.12591837783013074,"z":-0.04303359987204212}},{"Q":{"w":0.9898534383898226,"x":0.04982812373070708,"y":0.12591837783013074,"z":-0.04303359987204212}}],"2":[{"Q":{"w":0.9997839952930438,"x":-0.0061991036910615804,"y":0.01912280953040795,"z":0.005277501773005278}},{"Q":{"w":0.989104957664342,"x":0.05130743134934567,"y":-0.12741334522547923,"z":0.05296007619517664}},{"Q":{"w":0.9970048583907077,"x":0.04549052849280918,"y":-0.023325740353784638,"z":0.058033042309632986}},{"Q":{"w":0.9970048583907077,"x":0.04549052849280918,"y":-0.023325740353784638,"z":0.058033042309632986}}]},{"0":[{"Q":{"w":0.9822776805218206,"x":-0.10324154442978842,"y":0.1555775006727322,"z":-0.016351854232752785}},{"Q":{"w":0.9822776805218206,"x":-0.10324154442978842,"y":0.1555775006727322,"z":-0.016351854232752785}},{"Q":{"w":0.9822776805218206,"x":-0.10324154442978842,"y":0.1555775006727322,"z":-0.016351854232752785}}],"1":[{"Q":{"w":0.9863347480510389,"x":0.05169161377505289,"y":0.15110408990407326,"z":-0.0404882188628362}},{"Q":{"w":0.9822776805218206,"x":-0.10324154442978842,"y":0.1555775006727322,"z":-0.016351854232752785}},{"Q":{"w":0.9822776805218206,"x":-0.10324154442978842,"y":0.1555775006727322,"z":-0.016351854232752785}}],"2":[{"Q":{"w":0.9863347480510389,"x":0.05169161377505289,"y":0.15110408990407326,"z":-0.0404882188628362}},{"Q":{"w":0.9843920833245939,"x":0.08423863836227277,"y":0.142348926063196,"z":0.06010708230641}},{"Q":{"w":0.9843920833245939,"x":0.08423863836227277,"y":0.142348926063196,"z":0.06010708230641}},{"Q":{"w":0.9843920833245939,"x":0.08423863836227277,"y":0.142348926063196,"z":0.06010708230641}}]},{"0":[{"Q":{"w":0.9863347480510388,"x":0.1562200770427063,"y":0.05169161377505294,"z":-0.00818714731723385}},{"Q":{"w":0.9646020585144789,"x":0.25846434259635315,"y":0.05055265177859405,"z":-0.013545542219326034}},{"Q":{"w":0.9646020585144789,"x":0.25846434259635315,"y":0.05055265177859405,"z":-0.013545542219326034}}],"1":[{"Q":{"w":0.9972609476841359,"x":0.052264231633826624,"y":0.05226423163382674,"z":-0.0027390523158633286}},{"Q":{"w":0.9863347480510388,"x":0.15622007704270627,"y":0.05169161377505294,"z":-0.008187147317233849}},{"Q":{"w":0.9768070834421023,"x":0.20762675507137565,"y":0.051192290031144956,"z":-0.01088125715303472}}],"2":[{"Q":{"w":0.9972609476841359,"x":0.052264231633826624,"y":0.05226423163382674,"z":-0.0027390523158633286}},{"Q":{"w":0.9929121996744834,"x":0.06438264423127191,"y":-0.02280277731840759,"z":0.09726393065228599}},{"Q":{"w":0.9871464759924377,"x":0.07261475895087688,"y":-0.10925400611220504,"z":0.09128249485333578}},{"Q":{"w":0.9800757131716905,"x":0.07729259960382062,"y":-0.1607675320668211,"z":0.08735703251957849}}]},{"0":[{"Q":{"w":0.9931589376748547,"x":0.10438521064158723,"y":0.0520492543986435,"z":-0.005470597079718073}},{"Q":{"w":0.9863347480510383,"x":0.15622007704270618,"y":0.05169161377505291,"z":-0.008187147317233847}},{"Q":{"w":0.9863347480510383,"x":0.15622007704270618,"y":0.05169161377505291,"z":-0.008187147317233847}}],"1":[{"Q":{"w":0.9768070834421019,"x":0.20762675507137554,"y":0.05119229003114493,"z":-0.010881257153034715}},{"Q":{"w":0.9863347480510384,"x":0.1562200770427062,"y":0.051691613775052915,"z":-0.008187147317233847}},{"Q":{"w":0.9661049806258866,"x":0.15557750067273207,"y":0.20535195289412184,"z":0.01635185423275276}}],"2":[{"Q":{"w":0.9768070834421019,"x":0.20762675507137554,"y":0.05119229003114493,"z":-0.010881257153034715}},{"Q":{"w":0.9448180294714694,"x":0.19410228498739782,"y":-0.25316322799124485,"z":-0.07450888632485672}},{"Q":{"w":0.9131794542702794,"x":0.18525067297365802,"y":-0.3505367500276283,"z":-0.09438993241604854}},{"Q":{"w":0.9727892058317115,"x":0.20336832153789974,"y":-0.10224426555364656,"z":-0.04322727117869945}}]},{"0":[{"Q":{"w":0.9775628103387355,"x":-0.03477109863717863,"y":0.0036590614537610005,"z":-0.20772225160409025}},{"Q":{"w":0.9725145609384398,"x":0.005582322647317298,"y":0.11120841317565437,"z":-0.20449194428027193}},{"Q":{"w":0.9768070834421023,"x":0.05204925439864346,"y":-0.005470597079718068,"z":-0.20762675507137562}}],"1":[{"Q":{"w":0.9876883405951373,"x":-2.7755575615628914e-17,"y":-1.734723475976807e-18,"z":-0.15643446504023079}},{"Q":{"w":0.9876883405951373,"x":-2.7755575615628914e-17,"y":-1.734723475976807e-18,"z":-0.15643446504023079}},{"Q":{"w":0.9876883405951373,"x":-2.7755575615628914e-17,"y":-1.734723475976807e-18,"z":-0.15643446504023079}}],"2":[{"Q":{"w":0.9876883405951373,"x":-2.7755575615628914e-17,"y":-1.734723475976807e-18,"z":-0.15643446504023079}},{"Q":{"w":0.7178227796016965,"x":0.19234003410293837,"y":-0.1731837445866703,"z":-0.646330533842485}},{"Q":{"w":0.7431448254773936,"x":-2.2332986245237738e-17,"y":-1.6571631442408468e-17,"z":-0.6691306063588578}},{"Q":{"w":0.9768070834421011,"x":-0.0161726998959332,"y":0.049774452221389535,"z":-0.20762675507137582}}]},{"0":[{"Q":{"w":0.9510565162951533,"x":0.30901699437494734,"y":0,"z":0}},{"Q":{"w":0.9135454576426003,"x":0.40673664307579993,"y":0,"z":0}},{"Q":{"w":0.9335804264972014,"x":0.35836794954530016,"y":0,"z":0}}],"1":[{"Q":{"w":0.9659258262890681,"x":0.2588190451025207,"y":0,"z":0}},{"Q":{"w":0.9659258262890681,"x":0.2588190451025207,"y":0,"z":0}},{"Q":{"w":0.9659258262890681,"x":0.2588190451025207,"y":0,"z":0}}],"2":[{"Q":{"w":0.9659258262890681,"x":0.2588190451025207,"y":0,"z":0}},{"Q":{"w":0.4539904997395464,"x":0.891006524188367,"y":0,"z":0}},{"Q":{"w":0.9659258262890681,"x":0.2588190451025207,"y":0,"z":0}},{"Q":{"w":0.4999999999999996,"x":0.8660254037844379,"y":0,"z":0}}]},{"0":[{"Q":{"w":0.9824088108221345,"x":-0.0686967161660071,"y":0.012113084546138426,"z":0.17322517943366061}},{"Q":{"w":0.9876883405951374,"x":-0.15643446504023084,"y":0,"z":0}},{"Q":{"w":0.9972609476841362,"x":-0.05226423163382671,"y":0.013545542219326025,"z":0.05055265177859401}}],"1":[{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0}},{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0}},{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0}}],"2":[{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0}},{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0}},{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0}},{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0}}]},{"0":[{"Q":{"w":0.976807083442102,"x":-0.0511922900311449,"y":-0.010881257153034703,"z":0.2076267550713756}},{"Q":{"w":0.9762696046550686,"x":0.10394001243010234,"y":0.010924535519970812,"z":0.18967020684951447}},{"Q":{"w":0.9764253798537532,"x":0.06185674589560991,"y":0.012630610011312583,"z":0.20641629842480652}}],"1":[{"Q":{"w":0.9822776805218202,"x":-0.10324154442978836,"y":-0.01635185423275277,"z":0.15557750067273213}},{"Q":{"w":0.9876883405951369,"x":-6.938893903907228e-18,"y":3.469446951953614e-18,"z":0.1564344650402307}},{"Q":{"w":0.9876883405951369,"x":-6.938893903907228e-18,"y":3.469446951953614e-18,"z":0.1564344650402307}}],"2":[{"Q":{"w":0.9822776805218202,"x":-0.10324154442978836,"y":-0.01635185423275277,"z":0.15557750067273213}},{"Q":{"w":0.9284661752387171,"x":-0.10438521064158722,"y":0.005470597079718072,"z":0.35640477242103336}},{"Q":{"w":0.9284661752387171,"x":-0.10438521064158722,"y":0.005470597079718072,"z":0.35640477242103336}},{"Q":{"w":0.9611073415131164,"x":0.08213170706284914,"y":0.0885218030819842,"z":0.24837663167786594}}]},{"0":[{"Q":{"w":0.9510565162951533,"x":0.30901699437494734,"y":0,"z":0}},{"Q":{"w":0.9510565162951532,"x":0.30901699437494734,"y":0,"z":0}},{"Q":{"w":0.951056516295153,"x":0.3090169943749474,"y":0,"z":0}}],"1":[{"Q":{"w":0.9335804264972014,"x":0.35836794954530016,"y":0,"z":0}},{"Q":{"w":0.9659258262890681,"x":0.2588190451025207,"y":0,"z":0}},{"Q":{"w":0.9659258262890681,"x":0.2588190451025207,"y":0,"z":0}}],"2":[{"Q":{"w":0.9335804264972014,"x":0.35836794954530016,"y":0,"z":0}},{"Q":{"w":0.9781476007338047,"x":0.2079116908177593,"y":0,"z":0}},{"Q":{"w":0.9999999999999992,"x":1.457167719820518e-16,"y":0,"z":0}},{"Q":{"w":0.9876883405951368,"x":0.15643446504023087,"y":0,"z":0}}]},{"0":[{"Q":{"w":0.9999999999999996,"x":-1.3877787807814457e-17,"y":0,"z":0}},{"Q":{"w":0.9970820388721084,"x":-0.053393817416753066,"y":-0.02926601663288521,"z":-0.04604354776456289}},{"Q":{"w":0.997082038872109,"x":-0.053393817416753066,"y":-0.019053492085513782,"z":-0.05112213277682344}}],"1":[{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0}},{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0}},{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0}}],"2":[{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0}},{"Q":{"w":0.9999999999999998,"x":-6.938893903907228e-18,"y":0,"z":0}},{"Q":{"w":0.9999999999999998,"x":-6.938893903907228e-18,"y":0,"z":0}},{"Q":{"w":0.9999999999999998,"x":-6.938893903907228e-18,"y":0,"z":0}}]},{"0":[{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}}],"1":[{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}}],"2":[{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}}]},{"0":[{"Q":{"w":0.8470362954913784,"x":-0.36866770746959954,"y":0.3458274007401125,"z":-0.16436862379020875}},{"Q":{"w":0.751876193759431,"x":-0.5367201819090448,"y":0.3724444007915598,"z":-0.08887521537732258}},{"Q":{"w":0.8038598731196004,"x":-0.455187509493382,"y":0.3611141217085496,"z":-0.12731938851570215}}],"1":[{"Q":{"w":0.9157954119330531,"x":-0.28175489258486636,"y":0.2526641287658039,"z":-0.134513129552002}},{"Q":{"w":0.8470362954913784,"x":-0.36866770746959954,"y":0.3458274007401125,"z":-0.16436862379020875}},{"Q":{"w":0.8542291092999446,"x":-0.4867432787021712,"y":0.17006676468228335,"z":-0.0667151033378592}}],"2":[{"Q":{"w":0.9157954119330531,"x":-0.28175489258486636,"y":0.2526641287658039,"z":-0.134513129552002}},{"Q":{"w":0.9541925907325326,"x":0.09839598898278493,"y":-0.08583010068583337,"z":-0.2691986681978402}},{"Q":{"w":0.9438937313427898,"x":0.16471696920756207,"y":0.16405770425185728,"z":-0.23455919010447335}},{"Q":{"w":0.9402299947852668,"x":-0.18448472272585575,"y":0.237219557510347,"z":-0.16018684565672503}}]},{"0":[{"Q":{"w":0.4539904997395464,"x":-0.891006524188367,"y":0,"z":0}},{"Q":{"w":0.5446390350150265,"x":-0.8386705679454232,"y":0,"z":0}},{"Q":{"w":0.4539904997395464,"x":-0.891006524188367,"y":0,"z":0}}],"1":[{"Q":{"w":0.4539904997395464,"x":-0.891006524188367,"y":0,"z":0}},{"Q":{"w":0.4539904997395464,"x":-0.891006524188367,"y":0,"z":0}},{"Q":{"w":0.5446390350150265,"x":-0.8386705679454232,"y":0,"z":0}}],"2":[{"Q":{"w":0.4539904997395464,"x":-0.891006524188367,"y":0,"z":0}},{"Q":{"w":0.3583679495452991,"x":-0.9335804264971994,"y":0,"z":0}},{"Q":{"w":0.9999999999999982,"x":-9.020562075079397e-17,"y":0,"z":0}},{"Q":{"w":0.6293203910498357,"x":-0.777145961456969,"y":0,"z":0}}]},{"0":[{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}}],"1":[{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}}],"2":[{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}}]},{"0":[{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}}],"1":[{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"w":0.9676262187089193,"x":-0.16981261924619068,"y":-0.16981261924619065,"z":0.07763278660830164}},{"Q":{"w":0.9676262187089193,"x":-0.16981261924619068,"y":-0.16981261924619065,"z":0.07763278660830164}}],"2":[{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}}]},{"0":[{"Q":{"w":0.8898544896078564,"x":-0.41143263373260297,"y":0.06372975452804422,"z":0.18660303752187066}},{"Q":{"w":0.8680953094159012,"x":-0.4127592563191677,"y":0.22516377593145984,"z":0.15919046485654137}},{"Q":{"w":0.8182424064849377,"x":-0.53569939279994,"y":-0.01565874369858909,"z":0.20799117416201382}}],"1":[{"Q":{"w":0.8503146346110168,"x":-0.5045184802275625,"y":0.06501036012322763,"z":0.13490655414711322}},{"Q":{"w":0.5535975067336373,"x":-0.6966454927935257,"y":0.4274216339206776,"z":0.15976734574167295}},{"Q":{"w":0.932515461813642,"x":-0.26180093213796357,"y":0.24523628825066673,"z":0.04164550798360526}}],"2":[{"Q":{"w":0.8503146346110168,"x":-0.5045184802275625,"y":0.06501036012322763,"z":0.13490655414711322}},{"Q":{"w":0.9278756526666736,"x":-0.2703461552923077,"y":-0.13761922004279412,"z":0.21684252300198859}},{"Q":{"w":0.8278896839465438,"x":-0.40259005735105063,"y":-0.0736490962806814,"z":0.38353060836653236}},{"Q":{"w":0.9038780012536288,"x":-0.1745985163533047,"y":0.028125461644654407,"z":0.3895239085656213}}]},{"0":[{"Q":{"w":0.48480962024633634,"x":-0.8746197071393946,"y":0,"z":0}},{"Q":{"w":0.5446390350150259,"x":-0.8386705679454225,"y":0,"z":0}},{"Q":{"w":0.5446390350150261,"x":-0.8386705679454227,"y":0,"z":0}}],"1":[{"Q":{"w":0.6691306063588572,"x":-0.7431448254773934,"y":0,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"w":0.4539904997395464,"x":-0.891006524188367,"y":0,"z":0}}],"2":[{"Q":{"w":0.6691306063588572,"x":-0.7431448254773934,"y":0,"z":0}},{"Q":{"w":0.4067366430757995,"x":-0.9135454576425995,"y":0,"z":0}},{"Q":{"w":0.4067366430757995,"x":-0.9135454576425995,"y":0,"z":0}},{"Q":{"w":0.6293203910498363,"x":-0.7771459614569696,"y":0,"z":0}}]},{"0":[{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}}],"1":[{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}}],"2":[{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}},{"Q":{"x":0,"y":0,"z":0,"w":1}}]},""]';

let motiondata= '[{"0":[{"Q":{"w":0.9085409600397956,"x":-0.09549150281252622,"y":-0.4045084971874735,"z":-0.04251555625535744},"P":{"x":0,"y":0,"z":0}},{"Q":{"w":0.8471006708862729,"x":-0.19773576836617307,"y":-0.4890738003669023,"z":-0.06424824579191724},"P":{"x":0,"y":0,"z":0}},{"Q":{"w":0.8935822975543757,"x":-0.1899367807373567,"y":-0.397848471555116,"z":-0.08456530317942905},"P":{"x":0,"y":0,"z":0}}],"1":[{"Q":{"w":0.9458465291882026,"x":-0.09052430460833638,"y":-0.30732416694677966,"z":-0.0522642316338267},"P":{"x":0,"y":0,"z":0}},{"Q":{"w":0.9085409600397956,"x":-0.09549150281252622,"y":-0.4045084971874735,"z":-0.04251555625535744},"P":{"x":0,"y":0,"z":0}},{"Q":{"w":0.9085409600397955,"x":-0.09549150281252622,"y":-0.4045084971874735,"z":-0.04251555625535744},"P":{"x":0,"y":0,"z":0}}],"2":[{"Q":{"w":0.9458465291882026,"x":-0.09052430460833638,"y":-0.30732416694677966,"z":-0.0522642316338267},"P":{"x":0,"y":0,"z":0}},{"Q":{"w":0.8062039377567942,"x":-0.2439081505784039,"y":0.4886773242663045,"z":-0.22746098033460724},"P":{"x":-0.017739348352716174,"y":0,"z":0.7998032980177195}},{"Q":{"w":0.6522542063053729,"x":-0.17672594815779716,"y":0.6806869815587674,"z":-0.28283851000365173},"P":{"x":0.37236181395383233,"y":0,"z":0.9908753313515359}},{"Q":{"w":0.9177551064303765,"x":-0.3022597444656699,"y":0.2156290359102971,"z":-0.14095648395482163},"P":{"x":-0.02156321187579099,"y":0,"z":0.3994183619885292}}]},{"0":[{"Q":{"w":0.9898534383898226,"x":0.04982812373070708,"y":0.12591837783013074,"z":-0.04303359987204212},"P":{"x":0,"y":0.2,"z":0}},{"Q":{"w":0.9898534383898226,"x":0.04982812373070708,"y":0.12591837783013074,"z":-0.04303359987204212},"P":{"x":0,"y":0.2,"z":0}},{"Q":{"w":0.9898534383898226,"x":0.04982812373070708,"y":0.12591837783013074,"z":-0.04303359987204212},"P":{"x":0,"y":0.2,"z":0}}],"1":[{"Q":{"w":0.9997839952930438,"x":-0.0061991036910615804,"y":0.01912280953040795,"z":0.005277501773005278},"P":{"x":0,"y":0.2,"z":0}},{"Q":{"w":0.9898534383898226,"x":0.04982812373070708,"y":0.12591837783013074,"z":-0.04303359987204212},"P":{"x":0,"y":0.2,"z":0}},{"Q":{"w":0.9898534383898226,"x":0.04982812373070708,"y":0.12591837783013074,"z":-0.04303359987204212},"P":{"x":0,"y":0.2,"z":0}}],"2":[{"Q":{"w":0.9997839952930438,"x":-0.0061991036910615804,"y":0.01912280953040795,"z":0.005277501773005278},"P":{"x":0,"y":0.2,"z":0}},{"Q":{"w":0.989104957664342,"x":0.05130743134934567,"y":-0.12741334522547923,"z":0.05296007619517664},"P":{"x":0,"y":0.2,"z":0}},{"Q":{"w":0.9970048583907077,"x":0.04549052849280918,"y":-0.023325740353784638,"z":0.058033042309632986},"P":{"x":0,"y":0.2,"z":0}},{"Q":{"w":0.9970048583907077,"x":0.04549052849280918,"y":-0.023325740353784638,"z":0.058033042309632986},"P":{"x":0,"y":0.2,"z":0}}]},{"0":[{"Q":{"w":0.9822776805218206,"x":-0.10324154442978842,"y":0.1555775006727322,"z":-0.016351854232752785},"P":{"x":0,"y":0.6,"z":0}},{"Q":{"w":0.9822776805218206,"x":-0.10324154442978842,"y":0.1555775006727322,"z":-0.016351854232752785},"P":{"x":0,"y":0.6,"z":0}},{"Q":{"w":0.9822776805218206,"x":-0.10324154442978842,"y":0.1555775006727322,"z":-0.016351854232752785},"P":{"x":0,"y":0.6,"z":0}}],"1":[{"Q":{"w":0.9863347480510389,"x":0.05169161377505289,"y":0.15110408990407326,"z":-0.0404882188628362},"P":{"x":0,"y":0.6,"z":0}},{"Q":{"w":0.9822776805218206,"x":-0.10324154442978842,"y":0.1555775006727322,"z":-0.016351854232752785},"P":{"x":0,"y":0.6,"z":0}},{"Q":{"w":0.9822776805218206,"x":-0.10324154442978842,"y":0.1555775006727322,"z":-0.016351854232752785},"P":{"x":0,"y":0.6,"z":0}}],"2":[{"Q":{"w":0.9863347480510389,"x":0.05169161377505289,"y":0.15110408990407326,"z":-0.0404882188628362},"P":{"x":0,"y":0.6,"z":0}},{"Q":{"w":0.9843920833245939,"x":0.08423863836227277,"y":0.142348926063196,"z":0.06010708230641},"P":{"x":0,"y":0.6,"z":0}},{"Q":{"w":0.9843920833245939,"x":0.08423863836227277,"y":0.142348926063196,"z":0.06010708230641},"P":{"x":0,"y":0.6,"z":0}},{"Q":{"w":0.9843920833245939,"x":0.08423863836227277,"y":0.142348926063196,"z":0.06010708230641},"P":{"x":0,"y":0.6,"z":0}}]},{"0":[{"Q":{"w":0.9863347480510388,"x":0.1562200770427063,"y":0.05169161377505294,"z":-0.00818714731723385},"P":{"x":0,"y":0.6,"z":0}},{"Q":{"w":0.9646020585144789,"x":0.25846434259635315,"y":0.05055265177859405,"z":-0.013545542219326034},"P":{"x":0,"y":0.6,"z":0}},{"Q":{"w":0.9646020585144789,"x":0.25846434259635315,"y":0.05055265177859405,"z":-0.013545542219326034},"P":{"x":0,"y":0.6,"z":0}}],"1":[{"Q":{"w":0.9972609476841359,"x":0.052264231633826624,"y":0.05226423163382674,"z":-0.0027390523158633286},"P":{"x":0,"y":0.6,"z":0}},{"Q":{"w":0.9863347480510388,"x":0.15622007704270627,"y":0.05169161377505294,"z":-0.008187147317233849},"P":{"x":0,"y":0.6,"z":0}},{"Q":{"w":0.9768070834421023,"x":0.20762675507137565,"y":0.051192290031144956,"z":-0.01088125715303472},"P":{"x":0,"y":0.6,"z":0}}],"2":[{"Q":{"w":0.9972609476841359,"x":0.052264231633826624,"y":0.05226423163382674,"z":-0.0027390523158633286},"P":{"x":0,"y":0.6,"z":0}},{"Q":{"w":0.9929121996744834,"x":0.06438264423127191,"y":-0.02280277731840759,"z":0.09726393065228599},"P":{"x":0,"y":0.6,"z":0}},{"Q":{"w":0.9871464759924377,"x":0.07261475895087688,"y":-0.10925400611220504,"z":0.09128249485333578},"P":{"x":0,"y":0.6,"z":0}},{"Q":{"w":0.9800757131716905,"x":0.07729259960382062,"y":-0.1607675320668211,"z":0.08735703251957849},"P":{"x":0,"y":0.6,"z":0}}]},{"0":[{"Q":{"w":0.9931589376748547,"x":0.10438521064158723,"y":0.0520492543986435,"z":-0.005470597079718073},"P":{"x":0,"y":0.3,"z":0}},{"Q":{"w":0.9863347480510383,"x":0.15622007704270618,"y":0.05169161377505291,"z":-0.008187147317233847},"P":{"x":0,"y":0.3,"z":0}},{"Q":{"w":0.9863347480510383,"x":0.15622007704270618,"y":0.05169161377505291,"z":-0.008187147317233847},"P":{"x":0,"y":0.3,"z":0}}],"1":[{"Q":{"w":0.9768070834421019,"x":0.20762675507137554,"y":0.05119229003114493,"z":-0.010881257153034715},"P":{"x":0,"y":0.3,"z":0}},{"Q":{"w":0.9863347480510384,"x":0.1562200770427062,"y":0.051691613775052915,"z":-0.008187147317233847},"P":{"x":0,"y":0.3,"z":0}},{"Q":{"w":0.9661049806258866,"x":0.15557750067273207,"y":0.20535195289412184,"z":0.01635185423275276},"P":{"x":0,"y":0.3,"z":0}}],"2":[{"Q":{"w":0.9768070834421019,"x":0.20762675507137554,"y":0.05119229003114493,"z":-0.010881257153034715},"P":{"x":0,"y":0.3,"z":0}},{"Q":{"w":0.9448180294714694,"x":0.19410228498739782,"y":-0.25316322799124485,"z":-0.07450888632485672},"P":{"x":0,"y":0.3,"z":0}},{"Q":{"w":0.9131794542702794,"x":0.18525067297365802,"y":-0.3505367500276283,"z":-0.09438993241604854},"P":{"x":0,"y":0.3,"z":0}},{"Q":{"w":0.9727892058317115,"x":0.20336832153789974,"y":-0.10224426555364656,"z":-0.04322727117869945},"P":{"x":0,"y":0.3,"z":0}}]},{"0":[{"Q":{"w":0.9775628103387355,"x":-0.03477109863717863,"y":0.0036590614537610005,"z":-0.20772225160409025},"P":{"x":-0.275,"y":-0.1,"z":0}},{"Q":{"w":0.9725145609384398,"x":0.005582322647317298,"y":0.11120841317565437,"z":-0.20449194428027193},"P":{"x":-0.275,"y":-0.1,"z":0}},{"Q":{"w":0.9768070834421023,"x":0.05204925439864346,"y":-0.005470597079718068,"z":-0.20762675507137562},"P":{"x":-0.275,"y":-0.1,"z":0}}],"1":[{"Q":{"w":0.9876883405951373,"x":-2.7755575615628914e-17,"y":-1.734723475976807e-18,"z":-0.15643446504023079},"P":{"x":-0.275,"y":-0.1,"z":0}},{"Q":{"w":0.9876883405951373,"x":-2.7755575615628914e-17,"y":-1.734723475976807e-18,"z":-0.15643446504023079},"P":{"x":-0.275,"y":-0.1,"z":0}},{"Q":{"w":0.9876883405951373,"x":-2.7755575615628914e-17,"y":-1.734723475976807e-18,"z":-0.15643446504023079},"P":{"x":-0.275,"y":-0.1,"z":0}}],"2":[{"Q":{"w":0.9876883405951373,"x":-2.7755575615628914e-17,"y":-1.734723475976807e-18,"z":-0.15643446504023079},"P":{"x":-0.275,"y":-0.1,"z":0}},{"Q":{"w":0.7178227796016965,"x":0.19234003410293837,"y":-0.1731837445866703,"z":-0.646330533842485},"P":{"x":-0.275,"y":-0.1,"z":0}},{"Q":{"w":0.7431448254773936,"x":-2.2332986245237738e-17,"y":-1.6571631442408468e-17,"z":-0.6691306063588578},"P":{"x":-0.275,"y":-0.1,"z":0}},{"Q":{"w":0.9768070834421011,"x":-0.0161726998959332,"y":0.049774452221389535,"z":-0.20762675507137582},"P":{"x":-0.275,"y":-0.1,"z":0}}]},{"0":[{"Q":{"w":0.9510565162951533,"x":0.30901699437494734,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}},{"Q":{"w":0.9135454576426003,"x":0.40673664307579993,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}},{"Q":{"w":0.9335804264972014,"x":0.35836794954530016,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}}],"1":[{"Q":{"w":0.9659258262890681,"x":0.2588190451025207,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}},{"Q":{"w":0.9659258262890681,"x":0.2588190451025207,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}},{"Q":{"w":0.9659258262890681,"x":0.2588190451025207,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}}],"2":[{"Q":{"w":0.9659258262890681,"x":0.2588190451025207,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}},{"Q":{"w":0.4539904997395464,"x":0.891006524188367,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}},{"Q":{"w":0.9659258262890681,"x":0.2588190451025207,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}},{"Q":{"w":0.4999999999999996,"x":0.8660254037844379,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}}]},{"0":[{"Q":{"w":0.9824088108221345,"x":-0.0686967161660071,"y":0.012113084546138426,"z":0.17322517943366061},"P":{"x":0,"y":-1,"z":0}},{"Q":{"w":0.9876883405951374,"x":-0.15643446504023084,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}},{"Q":{"w":0.9972609476841362,"x":-0.05226423163382671,"y":0.013545542219326025,"z":0.05055265177859401},"P":{"x":0,"y":-1,"z":0}}],"1":[{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}},{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}},{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}}],"2":[{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}},{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}},{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}},{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}}]},{"0":[{"Q":{"w":0.976807083442102,"x":-0.0511922900311449,"y":-0.010881257153034703,"z":0.2076267550713756},"P":{"x":0.275,"y":-0.1,"z":0}},{"Q":{"w":0.9762696046550686,"x":0.10394001243010234,"y":0.010924535519970812,"z":0.18967020684951447},"P":{"x":0.275,"y":-0.1,"z":0}},{"Q":{"w":0.9764253798537532,"x":0.06185674589560991,"y":0.012630610011312583,"z":0.20641629842480652},"P":{"x":0.275,"y":-0.1,"z":0}}],"1":[{"Q":{"w":0.9822776805218202,"x":-0.10324154442978836,"y":-0.01635185423275277,"z":0.15557750067273213},"P":{"x":0.275,"y":-0.1,"z":0}},{"Q":{"w":0.9876883405951369,"x":-6.938893903907228e-18,"y":3.469446951953614e-18,"z":0.1564344650402307},"P":{"x":0.275,"y":-0.1,"z":0}},{"Q":{"w":0.9876883405951369,"x":-6.938893903907228e-18,"y":3.469446951953614e-18,"z":0.1564344650402307},"P":{"x":0.275,"y":-0.1,"z":0}}],"2":[{"Q":{"w":0.9822776805218202,"x":-0.10324154442978836,"y":-0.01635185423275277,"z":0.15557750067273213},"P":{"x":0.275,"y":-0.1,"z":0}},{"Q":{"w":0.9284661752387171,"x":-0.10438521064158722,"y":0.005470597079718072,"z":0.35640477242103336},"P":{"x":0.275,"y":-0.1,"z":0}},{"Q":{"w":0.9284661752387171,"x":-0.10438521064158722,"y":0.005470597079718072,"z":0.35640477242103336},"P":{"x":0.275,"y":-0.1,"z":0}},{"Q":{"w":0.9611073415131164,"x":0.08213170706284914,"y":0.0885218030819842,"z":0.24837663167786594},"P":{"x":0.275,"y":-0.1,"z":0}}]},{"0":[{"Q":{"w":0.9510565162951533,"x":0.30901699437494734,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}},{"Q":{"w":0.9510565162951532,"x":0.30901699437494734,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}},{"Q":{"w":0.951056516295153,"x":0.3090169943749474,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}}],"1":[{"Q":{"w":0.9335804264972014,"x":0.35836794954530016,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}},{"Q":{"w":0.9659258262890681,"x":0.2588190451025207,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}},{"Q":{"w":0.9659258262890681,"x":0.2588190451025207,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}}],"2":[{"Q":{"w":0.9335804264972014,"x":0.35836794954530016,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}},{"Q":{"w":0.9781476007338047,"x":0.2079116908177593,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}},{"Q":{"w":0.9999999999999992,"x":1.457167719820518e-16,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}},{"Q":{"w":0.9876883405951368,"x":0.15643446504023087,"y":0,"z":0},"P":{"x":0,"y":-1.2,"z":0}}]},{"0":[{"Q":{"w":0.9999999999999996,"x":-1.3877787807814457e-17,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}},{"Q":{"w":0.9970820388721084,"x":-0.053393817416753066,"y":-0.02926601663288521,"z":-0.04604354776456289},"P":{"x":0,"y":-1,"z":0}},{"Q":{"w":0.997082038872109,"x":-0.053393817416753066,"y":-0.019053492085513782,"z":-0.05112213277682344},"P":{"x":0,"y":-1,"z":0}}],"1":[{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}},{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}},{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}}],"2":[{"Q":{"w":0.9945218953682732,"x":-0.10452846326765346,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}},{"Q":{"w":0.9999999999999998,"x":-6.938893903907228e-18,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}},{"Q":{"w":0.9999999999999998,"x":-6.938893903907228e-18,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}},{"Q":{"w":0.9999999999999998,"x":-6.938893903907228e-18,"y":0,"z":0},"P":{"x":0,"y":-1,"z":0}}]},{"0":[{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":-0.2,"y":0.45,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":-0.2,"y":0.45,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":-0.2,"y":0.45,"z":0}}],"1":[{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":-0.2,"y":0.45,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":-0.2,"y":0.45,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":-0.2,"y":0.45,"z":0}}],"2":[{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":-0.2,"y":0.45,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":-0.2,"y":0.45,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":-0.2,"y":0.45,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":-0.2,"y":0.45,"z":0}}]},{"0":[{"Q":{"w":0.8470362954913784,"x":-0.36866770746959954,"y":0.3458274007401125,"z":-0.16436862379020875},"P":{"x":-0.4,"y":0,"z":0}},{"Q":{"w":0.751876193759431,"x":-0.5367201819090448,"y":0.3724444007915598,"z":-0.08887521537732258},"P":{"x":-0.4,"y":0,"z":0}},{"Q":{"w":0.8038598731196004,"x":-0.455187509493382,"y":0.3611141217085496,"z":-0.12731938851570215},"P":{"x":-0.4,"y":0,"z":0}}],"1":[{"Q":{"w":0.9157954119330531,"x":-0.28175489258486636,"y":0.2526641287658039,"z":-0.134513129552002},"P":{"x":-0.4,"y":0,"z":0}},{"Q":{"w":0.8470362954913784,"x":-0.36866770746959954,"y":0.3458274007401125,"z":-0.16436862379020875},"P":{"x":-0.4,"y":0,"z":0}},{"Q":{"w":0.8542291092999446,"x":-0.4867432787021712,"y":0.17006676468228335,"z":-0.0667151033378592},"P":{"x":-0.4,"y":0,"z":0}}],"2":[{"Q":{"w":0.9157954119330531,"x":-0.28175489258486636,"y":0.2526641287658039,"z":-0.134513129552002},"P":{"x":-0.4,"y":0,"z":0}},{"Q":{"w":0.9541925907325326,"x":0.09839598898278493,"y":-0.08583010068583337,"z":-0.2691986681978402},"P":{"x":-0.4,"y":0,"z":0}},{"Q":{"w":0.9438937313427898,"x":0.16471696920756207,"y":0.16405770425185728,"z":-0.23455919010447335},"P":{"x":-0.4,"y":0,"z":0}},{"Q":{"w":0.9402299947852668,"x":-0.18448472272585575,"y":0.237219557510347,"z":-0.16018684565672503},"P":{"x":-0.4,"y":0,"z":0}}]},{"0":[{"Q":{"w":0.4539904997395464,"x":-0.891006524188367,"y":0,"z":0},"P":{"x":0,"y":-0.8,"z":0}},{"Q":{"w":0.5446390350150265,"x":-0.8386705679454232,"y":0,"z":0},"P":{"x":0,"y":-0.8,"z":0}},{"Q":{"w":0.4539904997395464,"x":-0.891006524188367,"y":0,"z":0},"P":{"x":0,"y":-0.8,"z":0}}],"1":[{"Q":{"w":0.4539904997395464,"x":-0.891006524188367,"y":0,"z":0},"P":{"x":0,"y":-0.8,"z":0}},{"Q":{"w":0.4539904997395464,"x":-0.891006524188367,"y":0,"z":0},"P":{"x":0,"y":-0.8,"z":0}},{"Q":{"w":0.5446390350150265,"x":-0.8386705679454232,"y":0,"z":0},"P":{"x":0,"y":-0.8,"z":0}}],"2":[{"Q":{"w":0.4539904997395464,"x":-0.891006524188367,"y":0,"z":0},"P":{"x":0,"y":-0.8,"z":0}},{"Q":{"w":0.3583679495452991,"x":-0.9335804264971994,"y":0,"z":0},"P":{"x":0,"y":-0.8,"z":0}},{"Q":{"w":0.9999999999999982,"x":-9.020562075079397e-17,"y":0,"z":0},"P":{"x":0,"y":-0.8,"z":0}},{"Q":{"w":0.6293203910498357,"x":-0.777145961456969,"y":0,"z":0},"P":{"x":0,"y":-0.8,"z":0}}]},{"0":[{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}}],"1":[{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}}],"2":[{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}}]},{"0":[{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0.2,"y":0.4,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0.2,"y":0.4,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0.2,"y":0.4,"z":0}}],"1":[{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0.2,"y":0.4,"z":0}},{"Q":{"w":0.9676262187089193,"x":-0.16981261924619068,"y":-0.16981261924619065,"z":0.07763278660830164},"P":{"x":0.2,"y":0.4,"z":0}},{"Q":{"w":0.9676262187089193,"x":-0.16981261924619068,"y":-0.16981261924619065,"z":0.07763278660830164},"P":{"x":0.2,"y":0.4,"z":0}}],"2":[{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0.2,"y":0.4,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0.2,"y":0.4,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0.2,"y":0.4,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0.2,"y":0.4,"z":0}}]},{"0":[{"Q":{"w":0.8898544896078564,"x":-0.41143263373260297,"y":0.06372975452804422,"z":0.18660303752187066},"P":{"x":0.4,"y":-0.1,"z":0}},{"Q":{"w":0.8680953094159012,"x":-0.4127592563191677,"y":0.22516377593145984,"z":0.15919046485654137},"P":{"x":0.4,"y":-0.1,"z":0}},{"Q":{"w":0.8182424064849377,"x":-0.53569939279994,"y":-0.01565874369858909,"z":0.20799117416201382},"P":{"x":0.4,"y":-0.1,"z":0}}],"1":[{"Q":{"w":0.8503146346110168,"x":-0.5045184802275625,"y":0.06501036012322763,"z":0.13490655414711322},"P":{"x":0.4,"y":-0.1,"z":0}},{"Q":{"w":0.5535975067336373,"x":-0.6966454927935257,"y":0.4274216339206776,"z":0.15976734574167295},"P":{"x":0.4,"y":-0.1,"z":0}},{"Q":{"w":0.932515461813642,"x":-0.26180093213796357,"y":0.24523628825066673,"z":0.04164550798360526},"P":{"x":0.4,"y":-0.1,"z":0}}],"2":[{"Q":{"w":0.8503146346110168,"x":-0.5045184802275625,"y":0.06501036012322763,"z":0.13490655414711322},"P":{"x":0.4,"y":-0.1,"z":0}},{"Q":{"w":0.9278756526666736,"x":-0.2703461552923077,"y":-0.13761922004279412,"z":0.21684252300198859},"P":{"x":0.4,"y":-0.1,"z":0}},{"Q":{"w":0.8278896839465438,"x":-0.40259005735105063,"y":-0.0736490962806814,"z":0.38353060836653236},"P":{"x":0.4,"y":-0.1,"z":0}},{"Q":{"w":0.9038780012536288,"x":-0.1745985163533047,"y":0.028125461644654407,"z":0.3895239085656213},"P":{"x":0.4,"y":-0.1,"z":0}}]},{"0":[{"Q":{"w":0.48480962024633634,"x":-0.8746197071393946,"y":0,"z":0},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"w":0.5446390350150259,"x":-0.8386705679454225,"y":0,"z":0},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"w":0.5446390350150261,"x":-0.8386705679454227,"y":0,"z":0},"P":{"x":0,"y":-0.7,"z":0}}],"1":[{"Q":{"w":0.6691306063588572,"x":-0.7431448254773934,"y":0,"z":0},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"w":0.4539904997395464,"x":-0.891006524188367,"y":0,"z":0},"P":{"x":0,"y":-0.7,"z":0}}],"2":[{"Q":{"w":0.6691306063588572,"x":-0.7431448254773934,"y":0,"z":0},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"w":0.4067366430757995,"x":-0.9135454576425995,"y":0,"z":0},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"w":0.4067366430757995,"x":-0.9135454576425995,"y":0,"z":0},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"w":0.6293203910498363,"x":-0.7771459614569696,"y":0,"z":0},"P":{"x":0,"y":-0.7,"z":0}}]},{"0":[{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}}],"1":[{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}}],"2":[{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}},{"Q":{"x":0,"y":0,"z":0,"w":1},"P":{"x":0,"y":-0.7,"z":0}}]},""]';


let motiondata0= '[{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},{"0":[{"Q":{"x":0,"y":0,"z":0.043619387365336,"w":0.9990482215818578}}]},""]';


		html.entry( "html_edit"			,"checkbox"	,	false	);	// ex) <input type="checkbox" name="html_name" onClick="html.request('(name)')">
		html.entry( "html_ik"			,"checkbox"	,	false	);	//
		html.entry( "html_textarea"		,"textbox"	,	motiondata	);
		html.entry( "html_textarea2"	,"textbox"	,	"sub"	);	// 
	}
	html.request = function( req )	// window.onload()の前に完了していないので、この定義までにボタンが押される可能性があり僅かに問題がある。
	{
		// ブラウザからのクリックを反映させる為の処理。
		if ( req=="(load)" ) g_tblKeymodel.loadKeyframe();
		if ( req=="(save)" ) g_tblKeymodel.saveKeyframe();
		if ( req=="(edit)" ) html.read("html_edit") ;	// htmlの設定がhtml.paramに反映される
		if ( req=="(ik)" ) html.read("html_ik") ;	// htmlの設定がhtml.paramに反映される

		console.log(req);
	}
	html.write_all();	// html.paramの設定値がhtmlに反映される

	html.set("html_edit",true );

	// 初期設定
//	g_tblKeymodel.load();


	//---------------------------------------------------------------------
	function drawYuka( s )
	//---------------------------------------------------------------------
	{
		gra3d.colorv(C0);

		let st = 2;
		for ( let i = -s ; i <= s ; i+=st )
		{
			let y =  0;
			let u1 = i;
			let u2 = i;
			let v1 = -s;
			let v2 = s;
			gra3d.line( vec3(u1,y,v1), vec3(u2,y,v2) );
			gra3d.line( vec3(v1,y,u1), vec3(v2,y,u2) );
		}
	}

	//---------------------------------------------------------------------
	function QP_mul( parent, child ) // QP child; QP parent
	//---------------------------------------------------------------------
	{
//		let P = vadd( parentP, qmul(qmul( parentQ, vpos ),qconjugation(parentQ)) );	//cul:16+16+4
		let P = vadd( parent.P, vmul_QvC( parent.Q, child.P ) );	//cul:16+16+4
		let Q = qmul( parent.Q, child.Q );											//cul:16
		return QP( Q, P );
	}
	//---------------------------------------------------------------------
	function model_calcVisibleModels( tree, parent_qp )	
	//---------------------------------------------------------------------
	{
		let model = null;
		let qp = parent_qp;
		for ( let t of tree )
		{
			if ( t instanceof Array == true ) 
			{
				model_calcVisibleModels(t,qp);
			}
			else
			{
				model = t;
				{
					// 計算部
					qp = QP_mul( parent_qp, model.qp );
					model.global_qp = qp;
				}
			}
			
		}
	}
	//---------------------------------------------------------------------
	function model_drawVisibleModels( tree )	
	//---------------------------------------------------------------------
	{
		let model = null;
		for ( let t of tree )
		{
			if ( t instanceof Array == true ) 
			{
				model_drawVisibleModels(t);
			}
			else
			{
				model = t;
				{
					// 描画部
					let M = mmul( mtrans(model.global_qp.P), mq(model.global_qp.Q) );	//cul:64
					gra3d.drawModel( M, model );
				}
			}
			
		}
	}
	//---------------------------------------------------------------------
	function form_insert( tblModel, act, cut  )
	//---------------------------------------------------------------------
	{
		for ( let model of tblModel )
		{
			if ( model.infForm[act] == undefined )  //			if ( model.infForm[act] instanceof Array == false )  
			{
				model.infForm[act] = [];	// cutが無かったららカットをつくる
			}
			let qp = QP( model.qp.Q, model.qp.P );
			model.infForm[act].splice( cut, 0, qp );	// cut～『0個』を『model.qp』で置き換え→insert
		}
	}
	//---------------------------------------------------------------------
	function form_delete( tblModel, act, cut  )
	//---------------------------------------------------------------------
	{
		for ( let model of tblModel )
		{
			if ( model.infForm[act] != undefined )  //			if ( model.infForm[act] instanceof Array == false )  
			{
				model.infForm[act].splice( cut, 1 );	// 	cut～『1個』を『』で置き換え→delete
			}
		}
	}
	//---------------------------------------------------------------------
	function form_get( tblModel, act, cut )
	//---------------------------------------------------------------------
	{
		for ( let model of tblModel )
		{
			if ( model.infForm[act] != undefined )
			{
				if ( model.infForm[act].length > 0 )
				{
					cut = Math.min( cut, model.infForm[act].length -1 );
					model.qp.Q = model.infForm[act][cut].Q;
					model.qp.P = model.infForm[act][cut].P;
				}
			}
		}
	}
	//---------------------------------------------------------------------
	function form_fix( tblModel, act, cut  )
	//---------------------------------------------------------------------
	{
		for ( let model of tblModel )
		{
			if ( model.infForm[act] != undefined )
			{
				if ( model.infForm[act].length > 0 )
				{
					cut = Math.min( cut, model.infForm[act].length -1 );
					model.infForm[act][cut].Q = model.qp.Q;
					model.infForm[act][cut].P = model.qp.P;
				}
			} 
		}
	}
	//---------------------------------------------------------------------
	function form_set( tblModel, act, cut  )
	//---------------------------------------------------------------------
	{
		for ( let model of tblModel )
		{
			if ( model.infForm[act] != undefined )
			{
				if ( model.infForm[act].length > 0 )
				{
					cut = Math.min( cut, model.infForm[act].length -1 );
					model.infForm[act][cut].Q = model.qp.Q;
					model.infForm[act][cut].P = model.qp.P;
				}
			}
			else
			{
				model.infForm[act] = [model.qp];	// 何もない所だったら新規アクション
			} 

		}
		return [ act, cut ];
	}
	//---------------------------------------------------------------------
	function cur_normalize(act,cut)
	//---------------------------------------------------------------------
	{
		if ( act < 0         ) act = 0;
		if ( act >= MaxAct   ) act = MaxAct-1;
		if ( cut < 0         ) cut = 0;
		return [act,cut];
	}
	let	g_ikL01 = length(PartSuneL.qp.P);
	let	g_ikL12 = length(PartFootL.qp.P);
	let	g_ikK01 = length(PartMune.qp.P);
	let	g_ikK12 = length(PartKubi.qp.P);
	let g_ikToL = vec3(0,0,0);	// ターゲット	FlooL
	let g_ikToR = vec3(0,0,0);	// ターゲット	FlootR
	let g_ikToK = vec3(0,0,0);	// ターゲット	Kubi
	let g_ikToEye = vec3(0,4,3);	// ターゲット	注視点

	let g_pos_play = vec3(0,2,-2); 
	let g_pos_edit = vec3(0,2,0); 

	// グローバル座標系に変換←ローカル座標系
	//---------------------------------------------------------------------
	function ik_calcIK( l_qp, l_qp0, l_qp1, l_qp2, a_ikTo, a_len01, a_len12, dir )
	//---------------------------------------------------------------------
	{
		let	qp0 = QP_mul( l_qp, l_qp0  );
		let	qp1 = QP_mul( qp0, l_qp1 );
		let	qp2 = QP_mul( qp1, l_qp2 );

		// グローバルＩＫ座標系←グローバル座標系
		let [qp,len] = ik_global2gik( qp0, qp1 ,a_ikTo );
		// グローバル座標系←グローバルＩＫ座標系
		[ qp0, qp1, qp2.P ] = ik_gik2global( qp, len, a_len01, a_len12 );

		// ローカルＩＫ座標系←グローバル座標系
		// g = p * c
		// c = p^-1 * g
		let Q0 = qmul( qinverse( l_qp.Q ), qp0.Q );
		let Q1 = qmul( qinverse( qp0.Q ), qp1.Q );

		return [ Q0, Q1 ];
	}

	//---------------------------------------------------------------------
	function calc_models( pos )
	//---------------------------------------------------------------------
	{
		let new_pos = vcopy3(pos);
		
		model_calcVisibleModels( g_tblVisibleModel, QP( qidentity(), pos ) );

		if ( html.get("html_ik") )
		{
				{ // IKグローバルで計算して、ローカル回転に変換
				
					[ PartHara.qp.Q, PartMune.qp.Q ] = ik_calcIK( 
						PartKoshi.global_qp, 
						PartHara.qp, 
						PartMune.qp, 
						PartKubi.qp, 
						g_ikToK,
						g_ikK01,
						g_ikK12,
						-1
						
					);
					[ PartMomoL.qp.Q, PartSuneL.qp.Q ] = ik_calcIK( 
						PartKoshi.global_qp, 
						PartMomoL.qp, 
						PartSuneL.qp, 
						PartFootL.qp, 
						g_ikToL,
						g_ikL01,
						g_ikL12,
						1
					);
					[ PartMomoR.qp.Q, PartSuneR.qp.Q ] = ik_calcIK( 
						PartKoshi.global_qp, 
						PartMomoR.qp, 
						PartSuneR.qp, 
						PartFootR.qp, 
						g_ikToR, 
						g_ikL01,
						g_ikL12,
						1
					);
					// 再計算
					model_calcVisibleModels( g_tblVisibleModel, QP( qidentity(), pos ) );
				}

			// 視線制御
			if ( html.get("html_edit") == false )
			{
				let vA = PartHead.global_qp.P;
				let qA = PartHead.global_qp.Q;
				let vB = g_ikToEye;
				let v1 = normalize( vsub( vB, vA ) );
				let vC = vadd( vA, v1 );

				let v2 = vmul_QvC( qA, vec4(0,0,1,0) );
				let vA2 = vadd(vA,vec3(0,0.1,0));
				let vC2 = vadd( vA2, v2 );

				let q = ik_qrot( v2, v1 );
				PartHead.global_qp.Q = qmul( PartHead.global_qp.Q, q );

	//			gra.colorv(C4);gra.linev2( gra3d.pers2d(vA), gra3d.pers2d(vB) );
	//			gra.colorv(C2);gra.linev2( gra3d.pers2d(vA), gra3d.pers2d(vC) );
	//			gra.colorv(C1);gra.linev2( gra3d.pers2d(vA2), gra3d.pers2d(vC2) );

			}
		}
		else
		{
			new_pos.y = pos.y - Math.min( PartFootL.global_qp.P.y, PartFootR.global_qp.P.y );
			model_calcVisibleModels( g_tblVisibleModel, QP( qidentity(), new_pos ) );
		}
		return new_pos;
	}

	//---------------------------------------------------------------------
	function cam_control( cam, pad )
	//---------------------------------------------------------------------
	{
		const dir = -1;
	//				if ( pad.now.R1 ) 
		{ // camera control	move
			let a = vec3(0,0,0);
			let b = vec3(0,0,0);
			let s = 0.05;
			b = a = vec3( pad.now.LX*s*dir, -pad.now.LY*s*dir, 0 );

			let v = vsub( cam.pos, cam.at ) ;
			let r = Math.atan2(v.x,v.z);
			let ma = vmul_Mv( mroty( r ) , a );
			let mb = vmul_Mv( mroty( r ) , b );
			cam.at = vadd( cam.at, mb );
			let zoom = length(v);
			zoom -= pad.now.R2*s;
			zoom += pad.now.L2*s;
			cam.pos = vadd( vscale(normalize(v),zoom) , cam.at );
		}
	//				else
		{ // camera control rotation
			let v =  vsub(cam.pos,cam.at);
			let zoom = length(v);
			let th = Math.atan2( v.x, v.z );
			let s = 2.0;

			v = vmul_Mv( mroty(-th) , v )
			v = vmul_Mv( mrotx(radians(pad.now.RY*s*dir)) , v )
			v = vmul_Mv( mroty(radians(pad.now.RX*s*dir)) , v )
			v = vmul_Mv( mroty(th) , v )

			
			cam.pos = vadd( vscale(normalize(v),zoom) , cam.at );
		}
	}

	//---------------------------------------------------------------------
	function drawScene( cam, pad, pos, flgMan )
	//---------------------------------------------------------------------
	{
		// プロジェクション計算
		let P = mperspective( cam.fovy,  canvas_gl.width/ canvas_gl.height, cam.near, cam.far );
		let V = mlookat( cam.pos, cam.at );

		// 描画 play
		gra3d.setProjectionMatrix( P );
		gra3d.setViewMatrix( V );

		gra3d.cls();
		if ( pad.now.R1 ) cam_control( cam, pad );

		if(flgMan)
		{
			model_drawVisibleModels( g_tblVisibleModel );
			if ( html.get("html_ik") )  // ターゲット位置表示
			{
				gra.colorv( C6 );gra.circlefillv2( gra3d.pers2d(g_ikToL), 6 );gra.colorv( C0 );
				gra.colorv( C6 );gra.circlefillv2( gra3d.pers2d(g_ikToR), 6 );gra.colorv( C0 );
				gra.colorv( C6 );gra.circlefillv2( gra3d.pers2d(g_ikToK), 6 );gra.colorv( C0 );
				gra.colorv( C4 );gra.circlefillv2( gra3d.pers2d(g_ikToEye), 6 );gra.colorv( C0 );
				gra.colorv( C6 );gra.circlefillv2( gra3d.pers2d(pos), 6 );gra.colorv( C0 );
				{//capture
					gra.colorv( C2 );gra.circlefillv2( gra3d.pers2d(g_ikToL), 3 );gra.colorv( C0 );
					gra.colorv( C2 );gra.circlefillv2( gra3d.pers2d(g_ikToR), 3 );gra.colorv( C0 );
					gra.colorv( C2 );gra.circlefillv2( gra3d.pers2d(g_ikToK), 3 );gra.colorv( C0 );
					gra.colorv( C2 );gra.circlefillv2( gra3d.pers2d(pos), 3 );gra.colorv( C0 );
				}
			}
		}

		drawYuka(10);		// in play

		gra3d.reload_flush_display();
//		return pos;
	}
	let ed_sel_ac = 0;
	let ed_sel_st = 0;
	let ed_sel_en = 0;
	//---------------------------------------------------------------------
	function game_edit( pad, cam )
	//---------------------------------------------------------------------
	{

		if(0)
		{
			// pad データひょうじ
			let y= 1;
			let x =114
			function d(a){return Math.floor(a*255);}
					gra.symbol( "LU>"+d(pad.now.LU), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "LD>"+d(pad.now.LD), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "LR>"+d(pad.now.LR), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "LL>"+d(pad.now.LL), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "ST>"+d(pad.now.ST), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "RD>"+d(pad.now.RD), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "L2>"+d(pad.now.L2), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "R2>"+d(pad.now.R2), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "RL>"+d(pad.now.RL), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "RU>"+d(pad.now.RU), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "RR>"+d(pad.now.RR), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "L1>"+d(pad.now.L1), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "R1>"+d(pad.now.R1), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "RX>"+d(pad.now.RX), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "RY>"+d(pad.now.RY), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "LX>"+d(pad.now.LX), x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "LY>"+d(pad.now.LY), x,16*(y++), 16 , "LT", 0 );
		}

		let model = g_tblCur[ curTblCur ][ curPart[curTblCur] ];

		if ( mode == "(modeNone)" )
		{
					if (pad.trig.L1 ) mode = "(modeED)";
			else	if (pad.trig.R1 ) mode = "(modeCAM)";
			else	if (pad.trig.RL ) mode = "(modeX)";
			else	if (pad.trig.RU ) mode = "(modeY)";
			else	if (pad.trig.RR ) mode = "(modeZ)";
			else	if (pad.trig.RD ) mode = "(modeSEL)";
			else	if (pad.trig.L2 ) mode = "(modeMENU)";
			else	if (pad.trig.R2 ) mode = "(modeCOPY)";
		}

		{ // modeED_ACT
			if ( mode == "(modeSEL)" && pad.trig.RL ) 	// in
			{
				ed_sel_ac = cur_numAct;
				ed_sel_st = cur_numCut;
				ed_sel_en = -1;
				mode = "(modeED_ACT)";
			}
			if ( mode ==  "(modeED_ACT)" && pad.release.RL ) // out
			{
				let st = ed_sel_st;
				let en = cur_numCut;
				ed_sel_st = Math.min(st,en);
				ed_sel_en = Math.max(st,en);
				mode = "(modeSEL)";
			}
		}
		
		switch( mode )
		{
			case "(modeED)"		:if (pad.now.L1 == false ) mode = "(modeNone)";break;
			case "(modeCAM)"		:if (pad.now.R1 == false ) mode = "(modeNone)";break;
			case "(modeX)"		:if (pad.now.RL == false ) mode = "(modeNone)";break;
			case "(modeY)"		:if (pad.now.RU == false ) mode = "(modeNone)";break;
			case "(modeZ)"		:if (pad.now.RR == false ) mode = "(modeNone)";break;
			case "(modeSEL)"		:if (pad.now.RD == false ) mode = "(modeNone)";break;
			case "(modeMENU)"		:if (pad.now.L2 == false ) mode = "(modeNone)";break;
			case "(modeCOPY)"		:if (pad.now.R2 == false ) mode = "(modeNone)";break;
//			case "(modeED_ACT)"		:if (pad.now.RL == false ) mode = "(modeSEL)";break;
			default				:	break;
		}

		switch( mode )
		{
			case "(modeSEL)":case "(modeED_ACT)":
			{
				const TH = 25;
				{
					let tx = 0;
					let ty = 0;
					let [SX,SY]=[12*12,16];
					for ( let act = 0 ; act < MaxAct ; act++ )
					{
						let px = SX*tx;
						let py = SY*ty;

						let maxcut = 0;
						if ( g_tblKeymodel[0].infForm[act] != undefined ) maxcut = g_tblKeymodel[0].infForm[act].length;

						if ( g_tblKeymodel[0].infForm[act] != undefined ) gra.colorv(C0); else gra.colorv(C8);

						gra.symbol( ""+strfloat(act,2,0) 	, px,py, 16 , "LT", 0 );

						{
							function foo(x){return (px+32+12*x);}
							for ( let i = 0 ; i < maxcut ; i++ )
							{
								let st = Math.min(ed_sel_st,cur_numCut);
								let en = Math.max(ed_sel_st,cur_numCut);
								if ( mode == "(modeED_ACT)" && act == cur_numAct && i >= st && i < en ) 
								{
//									gra.colorv(C2);
									gra.fillv2( vec2( foo(i)-0+0.5, py+2+0.5 ),vec2( foo(i)+8+0.5, py+12+0.5 ) );
								}
								else
								{
									gra.boxv2( vec2( foo(i)-0+0.5, py+2+0.5 ),vec2( foo(i)+8+0.5, py+12+0.5 ) );
								}
							}
							if ( act == cur_numAct )
							{
								let cut = Math.min( cur_numCut, maxcut );
								if ( mode == "(modeED_ACT)" ) gra.colorv(C2);
								gra.fillv2( vec2( foo(cut)-2, py+1 ),vec2( foo(cut)+1, py+14 ) );
								if ( mode == "(modeED_ACT)" ) gra.colorv(C0);
							}
						}

						ty++;
						if ( ty >= TH )
						{
							ty = 0;
							tx++;
						}
					}
					gra.colorv(C0);
				}

				if ( mode == "(modeED_ACT)" )	// act 追加 削除
				{
					let maxcut = 0;
					if ( g_tblKeymodel[0].infForm[cur_numAct] != undefined ) maxcut = g_tblKeymodel[0].infForm[cur_numAct].length;
					if ( pad.rep.LL ) cur_numCut--;
					if ( pad.rep.LR ) cur_numCut++;
					if ( cur_numCut < 0 ) cur_numCut = maxcut;
					if ( cur_numCut > maxcut ) cur_numCut = 0;
//					if ( pad.now.L1 ) 
					{
						if (pad.rep.LD ) 
						{
							// カットの追加
							if ( cur_numCut > maxcut ) cur_numCut = maxcut;
							form_insert( g_tblKeymodel, cur_numAct, cur_numCut );
						}
						if (pad.rep.LU ) 
						{
							// カットの削除
							form_delete( g_tblKeymodel, cur_numAct, cur_numCut );
							form_get( g_tblKeymodel, cur_numAct, cur_numCut );
						}
					}
				}
				if ( mode == "(modeSEL)" )	// act メニュー表示
				{
					let maxcut = 0;
					if ( g_tblKeymodel[0].infForm[cur_numAct] != undefined ) maxcut = g_tblKeymodel[0].infForm[cur_numAct].length;

					let [act, cut] = [cur_numAct,cur_numCut];

					if (pad.rep.LU ) cur_numAct--;
					if (pad.rep.LD ) cur_numAct++;
					if (pad.rep.L1 ) cur_numAct-=TH;
					if (pad.rep.R1 ) cur_numAct+=TH;
					if (pad.rep.LL ) cur_numCut--;
					if (pad.rep.LR ) if ( ++cur_numCut > maxcut ) cur_numCut = maxcut;

					if ( cur_numAct < 0         ) cur_numAct = 0;
					if ( cur_numAct >= MaxAct   ) cur_numAct = MaxAct-1;
					if ( cur_numCut < 0         ) cur_numCut = 0;

					if ( act != cur_numAct || cut != cur_numCut )
					{
						form_fix( g_tblKeymodel, act, cut );
						form_get( g_tblKeymodel, cur_numAct, cur_numCut );
					}
				}
			}
			break;

			case "(modeMENU)":	// IK 
			{
				let vt = vec3(0,0,0);
				{
					let a = vec3(0,0,0);
					let s = 0.05;

					// 関節移動操作
					if (pad.now.LR ) a = vec3( s, 0, 0 );
					else
					if (pad.now.LL ) a = vec3(-s, 0, 0 );
					if (pad.now.RU ) 
					{
						if (pad.now.LU ) a = vec3( 0, 0, -s );
						else
						if (pad.now.LD ) a = vec3( 0, 0, s );
					}
					else
					{
						if (pad.now.LU ) a = vec3( 0, s, 0 );
						else
						if (pad.now.LD ) a = vec3( 0, -s, 0 );
					}
					let v = vsub( cam.pos, cam.at );
					let r = Math.atan2(v.x,v.z);
					vt = vmul_Mv( mroty( r ) , a );

				}

				if (pad.now.RD )
				{
				}
				else
				{
					const tblMenu = 
					[
						"flgIK",
						"flgHide",
						"pad3",
					]; 
					const TH = 25;
					let model = g_tblCur[ curTblCur ][ curPart[curTblCur] ];

					{
						let tx = 0;
						let ty = 0;
						let [SX,SY]=[12*12,16];
						for ( let act = 0 ; act < tblMenu.length ; act++ )
						{
							let px = SX*tx;
							let py = SY*ty;
							let str = tblMenu[act];

							let val = model.param[str];

							gra.symbol( ""+strfloat(act,2,0)+")"+str+":"+val 	, px,py, 16 , "LT", 0 );
							ty++;
							if ( ty >= TH )
							{
								ty = 0;
								tx++;
							}
						}
						{
							let px = SX*Math.floor(cur_numTB/TH);
							let py = SY*(cur_numTB%TH);//+SY;
							gra.symbol( ">" 	, px,py, 16 , "LT", 0 );
						}
					}
					{
						let act = cur_numTB;
						let str = tblMenu[act];

						if (pad.rep.LU ) cur_numTB--;
						if (pad.rep.LD ) cur_numTB++;
						if (pad.rep.LL ) 
						{
							model.param[str] = false;
						}
						if (pad.rep.LR ) 
						{
							model.param[str] = true;

						}
						if ( cur_numTB < 0 ) cur_numTB = tblMenu.length-1;
						if ( cur_numTB > tblMenu.length-1 ) cur_numTB = 0;
					}
				}

			}
			break;

			case "(modeCOPY)":
				break;

		
			case "(modeX)":
			{
				if (pad.now.R1 )	// 平行移動
				{
						gra.symbol( ""+model.qp.P.x, 20,0,  16, "LT", 0 );
						gra.symbol( ""+model.qp.P.y, 20,16,  16, "LT", 0 );
						gra.symbol( ""+model.qp.P.z, 20,32,  16, "LT", 0 );
						let s = 0.1;

						if (pad.rep.LU ) {model.qp.P.x +=  s;}
						if (pad.rep.LD ) {model.qp.P.x += -s;}
						if (pad.rep.LR ) {model.qp.P.x +=  s;}
						if (pad.rep.LL ) {model.qp.P.x += -s;}
					
				}
				else
				{
					if (pad.trig.RD ) model.qp.Q  = qidentity();
					if (pad.rep.LU ) {model.qp.Q = qmul( model.qp.Q, qrotx( ang(-3.0)) );}
					if (pad.rep.LD ) {model.qp.Q = qmul( model.qp.Q, qrotx(-ang(-3.0)) );}
					if (pad.rep.LR ) {model.qp.Q = qmul( model.qp.Q, qrotx( ang(-1.0)) );}
					if (pad.rep.LL ) {model.qp.Q = qmul( model.qp.Q, qrotx(-ang(-1.0)) );}
				}
			}
			break;

			case "(modeY)":
			{
				if (pad.now.R1 )	// 平行移動
				{
					gra.symbol( ""+model.qp.P.x, 20,0,  16, "LT", 0 );
					gra.symbol( ""+model.qp.P.y, 20,16,  16, "LT", 0 );
					gra.symbol( ""+model.qp.P.z, 20,32,  16, "LT", 0 );
					let a = vec3(0,0,0);
					let b = vec3(0,0,0);
					let s = 0.05;
					if (pad.now.LR ) b = a = vec3( s, 0, 0 );
					else
					if (pad.now.LL ) b = a = vec3(-s, 0, 0 );
					else
					if (pad.now.LU ) b = a = vec3( 0, s, 0 );
					else
					if (pad.now.LD ) b = a = vec3( 0, -s, 0 );

					let v = vsub( cam.pos, cam.at ) ;
					let r = Math.atan2(v.x,v.z);
					let ma = vmul_Mv( mroty( r ) , a );
					let mb = vmul_Mv( mroty( r ) , b );
					model.qp.P = vadd( model.qp.P, ma );
				}
				else
				{
					if (pad.now.L2 ) {model.qp.Q = qinverse(qmul( qinverse(model.qp.Q),qroty( ang( pad.now.L2)) ));}
					if (pad.now.R2 ) {model.qp.Q = qinverse(qmul( qinverse(model.qp.Q),qroty( ang(-pad.now.R2)) ));}
					if (pad.rep.LU ) {model.qp.Q = qmul( model.qp.Q, qroty( ang(-3.0)) );}
					if (pad.rep.LD ) {model.qp.Q = qmul( model.qp.Q, qroty(-ang(-3.0)) );}
					if (pad.rep.LR ) {model.qp.Q = qmul( model.qp.Q, qroty( ang(-1.0)) );}
					if (pad.rep.LL ) {model.qp.Q = qmul( model.qp.Q, qroty(-ang(-1.0)) );}
				}
			}
			break;

			case "(modeZ)":
			{
				if (pad.now.R1 )	// 平行移動
				{
					gra.symbol( ""+model.qp.P.x, 20,0,  16, "LT", 0 );
					gra.symbol( ""+model.qp.P.y, 20,16,  16, "LT", 0 );
					gra.symbol( ""+model.qp.P.z, 20,32,  16, "LT", 0 );
					let s = 0.1;

					if (pad.rep.LU ) {model.qp.P.z +=  s;}
					if (pad.rep.LD ) {model.qp.P.z += -s;}
					if (pad.rep.LR ) {model.qp.P.z +=  s;}
					if (pad.rep.LL ) {model.qp.P.z += -s;}
					
				}
				else
				{
					if (pad.trig.R2 ) model.qp.Q  = qidentity();
					if ( model.name == "右脚" || model.name == "左脚" )
					{
					}
					else
					{
						if (pad.rep.LU ) {model.qp.Q = qmul( model.qp.Q, qrotz( ang(-3.0)) );}
						if (pad.rep.LD ) {model.qp.Q = qmul( model.qp.Q, qrotz(-ang(-3.0)) );}
						if (pad.rep.LR ) {model.qp.Q = qmul( model.qp.Q, qrotz( ang(-1.0)) );}
						if (pad.rep.LL ) {model.qp.Q = qmul( model.qp.Q, qrotz(-ang(-1.0)) );}
					}
				}
			}
			break;
			
			case "(modeED)":	// 主にキーフレーム編集
				break;

			case "(modeCAM)":	// 主にカメラコントロール
				break;

			case "(modeNone)":
			{
	
				if ( pad.now.count == 1 && pad.trig.LU ) 
				{
					if ( --curPart[curTblCur] < 0 ) curPart[curTblCur] = g_tblCur[ curTblCur ].length-1;
				}
				else
				if ( pad.now.count == 1 && pad.trig.LD ) 
				{
					if ( ++curPart[curTblCur] >= g_tblCur[ curTblCur ].length ) curPart[curTblCur] = 0;
				}
				else
				if ( pad.now.count == 1 && pad.trig.LL ) 
				{
					if ( --curTblCur < 0 ) curTblCur = g_tblCur.length-1;
				}
				else
				if ( pad.now.count == 1 && pad.trig.LR ) 
				{
					if ( ++curTblCur >= g_tblCur.length ) curTblCur = 0;
				}
			}
			break;

			default:
			{
			}
			break;
		}

		{	// カーソル位置の色を変更
			let curmodel = g_tblCur[ curTblCur ][ curPart[curTblCur] ];
			for ( let m of g_tblCur.flat() )
			{
				m.col_flat = C7;
				m.col_wire = C0;

				if ( m == curmodel )
				{
					m.col_flat = vec3(0.9,0.9,0);
				}
			}
		}
		{
			let maxcut = 0;
			if ( g_tblKeymodel[0].infForm[cur_numAct] != undefined ) maxcut = g_tblKeymodel[0].infForm[cur_numAct].length;

			let flgMan = (maxcut > 0) && maxcut > cur_numCut;
			if(flgMan) g_pos_edit = calc_models( g_pos_edit );
			drawScene( cam, pad, g_pos_edit, flgMan );
		}

		// キャンバス2D 
		{
			let tx = 640;
			let ty = 0;
			gra.symbol( ""+mode				, tx,16*(ty++), 16, "RT", 0 );
			gra.symbol( ""+ pad.now.count	, tx,16*(ty++), 16, "RT", 0 );
			gra.symbol( "sel.ac:"+ed_sel_ac	, tx,16*(ty++), 16, "RT", 0 );
			gra.symbol( "sel.st:"+ed_sel_st 	, tx,16*(ty++), 16, "RT", 0 );
			gra.symbol( "sel.en:"+ed_sel_en 	, tx,16*(ty++), 16, "RT", 0 );
		}


	}

	//---------------------------------------------------------------------
	function game_play( pad, cam )
	//---------------------------------------------------------------------
	{
		let anim_speed = 10;

		if ( anim_limTime > 0 && anim_numCut < anim_cntCut )
		{
			let t = (anim_speed-anim_limTime)/anim_speed;

			let now = anim_numCut;
			let next = anim_numCut+1;
			let nextact = anim_numAct;
			if ( next >= anim_cntCut ) 
			{
				nextact = anim_nextAct;
				next = 0;
			}

			for ( let model of g_tblKeymodel )
			{
				model.qp.Q = qslerp( model.infForm[anim_numAct][now].Q, model.infForm[nextact][next].Q, t );
				let v=	vadd(
							vscale( model.infForm[anim_numAct][now].P, 1-t ),
							vscale( model.infForm[nextact][next].P, t )
						);
				model.qp.P = vec3(v.x, v.y, v.z );
			}

			anim_limTime--;
			if ( anim_limTime <= 0 )
			{
				anim_numCut++;
				anim_limTime = anim_speed;
				if ( anim_numCut >= anim_cntCut )
				{
					anim_numCut = 0;
					anim_numAct = nextact;
					anim_cntCut = g_tblKeymodel[0].infForm[anim_numAct].length;
				} 
			
			}
		}

		function anim_setAction( act, next )
		{
			if ( g_tblKeymodel[0].infForm[cur_numAct] != undefined ) 
			{
				anim_limTime = anim_speed;
				anim_numAct = act;
				anim_numCut = 0;
				anim_nextAct = next;
				anim_cntCut = g_tblKeymodel[0].infForm[ act ].length;
			}
		}

		if ( pad.now.count == 1 )
		{
			if ( pad.trig.RL ) anim_setAction( 0, 0 );
			if ( pad.trig.RD ) anim_setAction( cur_numAct, 0 );
			if ( pad.trig.R2 ) anim_setAction( 2, 0 );
			if ( pad.trig.L2 ) anim_setAction( 1, 0 );	// パンチ
		}

		if ( pad.now.R1 == false  ) 
		{
			if ( html.get("html_ik") ) // play
			{ // ＩＫターゲット移動
				ik_move_target( cam, pad );
			}
			else
			{ // 移動
				let a = vec3(0,0,0);
				let b = vec3(0,0,0);
				let s = 0.05;
				b = a = vec3( pad.now.LX*s, pad.now.LY*s, 0 );
				let v = vsub( cam.pos, cam.at ) ;
				let r = Math.atan2(v.x,v.z);
				let ma = vmul_Mv( mroty( r ) , a );
				let mb = vmul_Mv( mroty( r ) , b );
			
				g_pos_play = vadd( g_pos_play, vscale(ma,1)  );	// 腰
			}
		}

		{	// 色を変更
			for ( let m of g_tblCur.flat() )
			{
				m.col_flat = C7;
				m.col_wire = C0;
			}
		}

		//g_pos_play = 
		{
			let flgMan = true;
			if(flgMan) g_pos_play = calc_models( g_pos_play );	
			drawScene( cam, pad, g_pos_play, flgMan );
		}

		// キャンバス2D 
		{
			let tx = 640;
			let ty = 0;
			gra.symbol( "pos.y:"+g_pos_play.y 	, tx, 16*(ty++), 16, "RT", 0 );
		}


	}
	
	//---------------------------------------------------------------------
	function ik_move_target( cam, pad )	// ＩＫ用ターゲットを動かす
	//---------------------------------------------------------------------
	{

		{ // 上半身
			let a = vec3(0,0,0);
			let b = vec3(0,0,0);
			let s = 0.05;
			b = a = vec3( pad.now.RX*s, -pad.now.RY*s, 0 );
			let v = vsub( cam.pos, cam.at ) ;
			let r = Math.atan2(v.x,v.z);
			let ma = vmul_Mv( mroty( r ) , a );
			let mb = vmul_Mv( mroty( r ) , b );
			g_ikToK = vadd( g_ikToK, vscale(ma,2) );
			g_pos_play = vadd( g_pos_play, vscale(ma,1.0)  );	// 腰
		}

		{ // 下半身
			let a = vec3(0,0,0);
			let b = vec3(0,0,0);
			let s = 0.05;
			b = a = vec3( pad.now.LX*s, -pad.now.LY*s, 0 );
			let v = vsub( cam.pos, cam.at ) ;
			let r = Math.atan2(v.x,v.z);
			let ma = vmul_Mv( mroty( r ) , a );
			let mb = vmul_Mv( mroty( r ) , b );
		
			if ( pad.now.RR )
			{
				g_ikToL = vadd( g_ikToL, ma );
			}
			else
			if ( pad.now.RD )
			{
				g_ikToR = vadd( g_ikToR, ma );
			}
			else
			{
				g_ikToK = vadd( g_ikToK, vscale(ma,1) );
				g_pos_play = vadd( g_pos_play, vscale(ma,1)  );	// 腰
			}
		}
	}


	let g_flgStop = false;

	//---------------------------------------------------------------------
	function ik_qrot( va, vb )	// vaからvbに球状線形回転するクォータニオンを返す
	//---------------------------------------------------------------------
	{
		let axis = normalize( cross( va, vb ) );
		let th	 = Math.acos( dot( va, vb ) );
		if ( th > radians(0.01) )
		{
			let q = vec4(
				axis.x*Math.sin(th/2),
				axis.y*Math.sin(th/2),
				axis.z*Math.sin(th/2),
				Math.cos(th/2)
			);
			return q;
		}
		return qidentity();
	}
	//---------------------------------------------------------------------
	function ik_global2gik( qp0, qp1, p2 )	// quat q0,q1,q2; vec3 p0,p1,p2
	//---------------------------------------------------------------------
	{
		let va=normalize( vsub( qp1.P, qp0.P ) );
		let vb=normalize( vsub( p2, qp0.P ) );

		let qp = QP( qmul( ik_qrot( va, vb ), qp0.Q ), qp0.P );
		let lm = length( vsub(p2,qp0.P) );

		return [qp,lm];
	}
	//---------------------------------------------------------------------
	function ik_gik2global( qp, c, a, b )	// QP qp, float c,a,b
	//---------------------------------------------------------------------
	{
		// ＩＫをグローバル座標のＦＫに変換

		// s=(a+b+c)/2
		// S=√(s(s-a)(s-b)(s-c))
		// h=2S/c
		// θa=asin(h/b)
		// θb=asin(h/a)

		let s = (a+b+c)/2;
		let S = Math.sqrt( s*(s-a)*(s-b)*(s-c) );
		let oa = 0;	// 辺aの向かいの角
		let ob = 0;	// 辺bの向かいの角
		let	oc = 0;	// 辺cの向かいの角

		if ( c > a+b )
		{
			// 伸びすぎ
			oa = 0;
			oc = -Math.PI;
			ob = 0;
		}
		else
		if ( (c > a && c > b) && (c < a+b) )	// 腰から足首までが一番長い
		{
			let h = 2*S/c;
			oa = Math.asin(h/b);
			ob = Math.asin(h/a);
			oc = Math.PI-oa-ob;
		}
		else
		if ( (a > b && a > c) && ( a < b+c) )	// 腿が一番長い
		{
			let h = 2*S/a;
			ob = Math.asin(h/c);
			oc = Math.asin(h/b);
			oa = Math.PI-ob-oc;
		}
		else
		if ( (b >= c && b >= a) && (b < c+a) )	// 脛が一番長い
		{
			let h = 2*S/b;
			oc = Math.asin(h/a);
			oa = Math.asin(h/c);
			ob = Math.PI-oc-oa;
		}
		else
		{
			// 縮みすぎ
			oa = 0;
			ob = 0;
			oc = 0;
		}
		let la = a*Math.cos( ob );
		let lh = a*Math.sin( ob );
		let vh = vmul_QvC( qp.Q, vec3( 0, -la, lh ) );
		let	q0 = qmul( qp.Q, qrotx(-ob));
		let	q1 = qmul( qp.Q, qrotx(Math.PI-oc-ob));
		let	p0 = qp.P;
		let	p1 = vadd( qp.P, vh ); 
		let p2 = vadd( vmul_QvC( q1, vec3(0,-b,0) ), p1 );
		return [QP(q0, p0), QP(q1, p1), p2];
	}

	//---------------------------------------------------------------------
	function ik_gik2lik( qp, c, a, b )	// QP qp, float c,a,b
	//---------------------------------------------------------------------
	{
		// ＩＫをグローバル座標のＦＫに変換

		// s=(a+b+c)/2
		// S=√(s(s-a)(s-b)(s-c))
		// h=2S/c
		// θa=asin(h/b)
		// θb=asin(h/a)

		let s = (a+b+c)/2;
		let S = Math.sqrt( s*(s-a)*(s-b)*(s-c) );
		let oa = 0;	// 辺aの向かいの角
		let ob = 0;	// 辺bの向かいの角
		let	oc = 0;	// 辺cの向かいの角

		if ( c > a+b )
		{
			// 伸びすぎ
			oa = 0;
			oc = -Math.PI;
			ob = 0;
		}
		else
		if ( (c > a && c > b) && (c < a+b) )	// 腰から足首までが一番長い
		{
			let h = 2*S/c;
			oa = Math.asin(h/b);
			ob = Math.asin(h/a);
			oc = Math.PI-oa-ob;
		}
		else
		if ( (a > b && a > c) && ( a < b+c) )	// 腿が一番長い
		{
			let h = 2*S/a;
			ob = Math.asin(h/c);
			oc = Math.asin(h/b);
			oa = Math.PI-ob-oc;
		}
		else
		if ( (b >= c && b >= a) && (b < c+a) )	// 脛が一番長い
		{
			let h = 2*S/b;
			oc = Math.asin(h/a);
			oa = Math.asin(h/c);
			ob = Math.PI-oc-oa;
		}
		else
		{
			// 縮みすぎ
			oa = 0;
			ob = 0;
			oc = 0;
		}
		let la = a*Math.cos( ob );
		let lh = a*Math.sin( ob );
		let vh = vmul_QvC( qp.Q, vec3( 0, -la, lh ) );
		let	q0 = qmul( qp.Q, qrotx(-ob));
		let	q1 = qmul( qp.Q, qrotx(Math.PI-oc-ob));
		let	p0 = qp.P;
		let	p1 = vadd( qp.P, vh ); 
		let p2 = vadd( vmul_QvC( q1, vec3(0,-b,0) ), p1 );
		return [QP(q0, p0), QP(q1, p1), p2];
	}

	
	//---------------------------------------------------------------------
	function	update_paint( now )
	//---------------------------------------------------------------------
	{
		gra.setBackcolor([1,0,0]);
		gra.cls();

		peri.setCont(13,6);

		let pad = peri.getinfo( 0.11 );

	   	document.getElementById("html_padinfo").innerHTML		= "pad:undefined";
		 if (pad.inf != undefined )
		 {	
		   	document.getElementById("html_padinfo").innerHTML		= pad.inf.id;

			if(0) // pad キーリスト表示
			{
				let y = 1;
				for ( let i = 0 ; i < pad.inf.buttons.length ; i++ )
				{
					let b = pad.inf.buttons[i];
					gra.symbol( i+":"+b.pressed+","+b.value , 4,16*(y++), 16 , "LT", 0 );
				}
				for ( let i = 0 ; i < pad.inf.axes.length ; i++ )
				{
					gra.symbol( "a"+i+":"+pad.inf.axes[i] , 4,16*(y++), 16 , "LT", 0 );
				}
			}
			//return;
		}
		if(0)
		{
			// pad データひょうじ
			let y= 1;
			let x =414
					gra.symbol( "lu>"+pad.now.LU, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "ld>"+pad.now.LD, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "lr>"+pad.now.LR, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "ll>"+pad.now.LL, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "lx>"+pad.now.LX, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "ly>"+pad.now.LY, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "l1>"+pad.now.L1, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "l2>"+pad.now.L2, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "l3>"+pad.now.L3, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "ru>"+pad.now.RU, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "rd>"+pad.now.RD, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "rr>"+pad.now.RR, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "rl>"+pad.now.RL, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "rx>"+pad.now.RX, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "ry>"+pad.now.RY, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "r1>"+pad.now.R1, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "r2>"+pad.now.R2, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "r3>"+pad.now.R3, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "se>"+pad.now.SE, x,16*(y++), 16 , "LT", 0 );
					gra.symbol( "st>"+pad.now.ST, x,16*(y++), 16 , "LT", 0 );
		}

		if ( pad.now.L1 && pad.trig.LD ) // ロード
		{
			// load
			g_tblKeymodel.loadKeyframe();

			//--
			anim_limTime=0;
			anim_numCut=0;
			anim_numAct=0;
			anim_cntCut=0;
			anim_nextAct=0;

			//--
			play_cam = cam_create( vec3( -12, ey, 0 ), vec3( 0, ey ,0 ), 28, 1.0,1000.0  );
		}
		
		if ( pad.now.count == 1 && pad.trig.R3 )	// IK モード切替
		{
			html.set("html_ik",!html.get("html_ik") );

			if ( html.get("html_ik") )	// ここに来た後腰が下がる
			{
				g_ikToK = PartKubi.global_qp.P;
				g_ikToL = PartFootL.global_qp.P;
				g_ikToR = PartFootR.global_qp.P;
			}
		}

		if ( pad.now.L1 && pad.trig.ST ) // エディタモード切替
		{
			anim_limTime=0;
			anim_numCut=0;
			anim_numAct=0;
			anim_cntCut=0;
			anim_nextAct=0;

			html.set("html_edit",!html.get("html_edit") );
			if ( html.get("html_edit") == true )
			{
				// エディットモードに入るときは、キーフレームからリカバリ
				form_get( g_tblKeymodel, cur_numAct, cur_numCut  );
			}
			else
			{
				// エディットモードから出るときは、編集中のものがあれば保存
				form_fix( g_tblKeymodel, cur_numAct, cur_numCut  );
				form_get( g_tblKeymodel, 0,0  );
			}
		}

		if ( html.get("html_edit") == true ) 
		{
			game_edit( pad, edit_cam ); 
		}
		else 
		{
			game_play( pad, play_cam );
		}


		// キャンバス2D 
		{
			let tx = 320;
			let ty = 0;
			gra.symbol( ""+now						, tx, 16*(ty++), 16, "LT", 0 );
		}

		// 合成
		{
			const ctx = canvas_out.getContext("2d");
			ctx.clearRect(0, 0, canvas_out.width, canvas_out.height);
			ctx.drawImage(canvas_gl, 0, 0, canvas_out.width, canvas_out.height);
			ctx.drawImage(canvas_dbg, 0, 0, canvas_out.width, canvas_out.height);
		}
		if( g_flgStop == false  ) window.requestAnimationFrame( update_paint );
	}


	update_paint(0);



}



